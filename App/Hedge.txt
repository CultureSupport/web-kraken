<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>culture.support Dashboard</title>
    <!-- Bulma CDN --><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- Font Awesome for Icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Define dark color variables */
        :root {
            --dark-bg-main: #121a24;
            --dark-bg-secondary: #1f2937;
            --glass-bg: rgba(30, 41, 59, 0.7); 
            --glass-hover: rgba(50, 61, 79, 0.8);
            --text-light: #f0f0f0;
            --text-secondary: #a0a7b4;
            --color-primary: #3273dc; /* Bulma Blue */
            --color-success: #00d1b2; /* Bulma Teal (Low Risk) */
            --color-danger: #ff3860; /* Bulma Red (High Risk) */
            --color-warning: #ffdd57; /* Bulma Yellow (Moderate Risk) */
        }

        /* Base Styles */
        html, body {
            height: 100%;
            margin: 0;
            overflow-x: hidden; 
            background-color: var(--dark-bg-main); 
            color: var(--text-light); 
        }
        
        .dashboard-layout {
            display: flex;
            min-height: 100vh;
            position: relative; 
            z-index: 1; 
            background-color: transparent; 
        }

        /* --- ANIMATED BACKGROUND --- */
        .animated-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 0; 
            pointer-events: none; 
            background: linear-gradient(135deg, var(--dark-bg-main) 0%, var(--dark-bg-secondary) 100%);
        }

        /* Signal Stream Pillars */
        .pillar-stream {
            position: absolute;
            bottom: -5%; 
            width: 3px;
            height: 150%; 
            background: rgba(255, 255, 255, 0.2); 
            box-shadow: 0 0 5px var(--color-primary); 
            animation: streamFlow 10s infinite linear;
        }
        @keyframes streamFlow {
            0% { transform: translateY(0); opacity: 0; }
            10% { opacity: 0.5; }
            90% { opacity: 0.5; }
            100% { transform: translateY(-100vh); opacity: 0; }
        }
        .pillar-stream:nth-child(1) { left: 5%; animation-delay: 0s; animation-duration: 8s; }
        .pillar-stream:nth-child(2) { left: 15%; animation-delay: 2s; animation-duration: 12s; width: 2px; }
        .pillar-stream:nth-child(3) { left: 30%; animation-delay: 4s; animation-duration: 9s; background: rgba(0, 209, 178, 0.3); } 
        .pillar-stream:nth-child(4) { left: 50%; animation-delay: 1s; animation-duration: 11s; }
        .pillar-stream:nth-child(5) { left: 70%; animation-delay: 3s; animation-duration: 15s; width: 4px; background: rgba(255, 56, 96, 0.3); } 
        .pillar-stream:nth-child(6) { left: 85%; animation-delay: 6s; animation-duration: 10s; }

        /* Bunching CSS Balls */
        .data-bunch {
            position: absolute;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: rgba(50, 115, 220, 0.8); 
            box-shadow: 0 0 8px var(--color-primary);
            animation: bunching 15s infinite ease-out;
            transform: scale(0);
        }
        @keyframes bunching {
            0% { transform: scale(0.2) translate(0, 0); opacity: 0; }
            20% { opacity: 0.8; }
            50% { transform: scale(1.5) translate(50px, -50px); opacity: 1; }
            80% { opacity: 0.6; }
            100% { transform: scale(0.5) translate(100px, 0); opacity: 0; }
        }
        .data-bunch:nth-child(7) { left: 10%; top: 10%; animation-delay: 1s; animation-duration: 14s; }
        .data-bunch:nth-child(8) { left: 40%; top: 35%; animation-delay: 5s; animation-duration: 18s; }
        .data-bunch:nth-child(9) { left: 65%; top: 75%; animation-delay: 9s; animation-duration: 12s; }
        .data-bunch:nth-child(10) { left: 90%; top: 50%; animation-delay: 3s; animation-duration: 16s; }


        /* --- GLASSMORPHISM & LAYOUT --- */
        
        .sidebar {
            width: 280px;
            flex-shrink: 0;
            background-color: var(--glass-bg); 
            backdrop-filter: blur(8px); 
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.3);
            border-right: 1px solid rgba(255, 255, 255, 0.05); /* Subtle separation */
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 2;
        }

        /* Main Content Area */
        .main-content {
            flex-grow: 1;
            padding: 1.5rem;
            z-index: 1; 
        }

        /* General Box/Card Styling */
        .modern-card {
            border-radius: 12px;
            background-color: var(--glass-bg);
            backdrop-filter: blur(10px); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); /* Stronger shadow */
            border: 1px solid rgba(255, 255, 255, 0.1); 
            transition: transform 0.2s;
        }
        .modern-card:hover {
            transform: translateY(-2px);
        }

        /* Sidebar/Panel Styling */
        .panel-heading {
            color: var(--text-light);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .panel-block {
            color: var(--text-secondary);
        }
        .panel-block.is-active {
            background-color: rgba(50, 115, 220, 0.2); 
            color: var(--color-primary);
            font-weight: 600;
            border-left: 5px solid var(--color-primary);
        }
        .panel-block:hover:not(.is-active) {
            background-color: var(--glass-hover); 
            color: var(--text-light);
        }

        /* Text Color Adjustments */
        .title {
            color: var(--text-light) !important;
            font-weight: 700;
        }
        .subtitle {
            color: var(--text-secondary) !important;
            font-weight: 400;
        }

        /* Table Specific Styling for Dark Theme */
        .table {
            background-color: transparent;
            color: var(--text-secondary);
        }
        .table thead th {
            color: var(--text-light);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .table tbody tr {
            border-color: rgba(255, 255, 255, 0.1);
        }
        .table.is-striped tbody tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.1); 
        }
        .table.is-hoverable tbody tr:hover {
            background-color: var(--glass-hover);
        }

        /* --- CUSTOM CHART MOCKS --- */

        /* Risk Gauge Mock (Existing) */
        .risk-gauge {
            width: 100px;
            height: 50px;
            border-radius: 50px 50px 0 0;
            background: conic-gradient(
                var(--color-danger) 0% 25%, 
                var(--color-warning) 25% 65%, 
                var(--color-success) 65% 100% 
            );
            position: relative;
            overflow: hidden;
            margin: 0 auto;
            border-top: 5px solid var(--dark-bg-main);
            transform: rotate(180deg);
        }
        .risk-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform-origin: bottom center;
            height: 50px;
            width: 2px;
            background: var(--text-light);
            box-shadow: 0 0 5px var(--text-light);
            transform: translateX(-50%) rotate(165deg); 
            transition: transform 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }
        .risk-circle {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-light);
            z-index: 10;
        }
        
        /* Utility class to set text color based on risk level */
        .has-text-risk-low { color: var(--color-success) !important; }
        .has-text-risk-moderate { color: var(--color-warning) !important; }
        .has-text-risk-high { color: var(--color-danger) !important; }

        /* Custom Modal for Simulator */
        .modal-card-body-scroll {
            max-height: 50vh;
            overflow-y: auto;
        }

        /* --- CANDLESTICK MOCK STYLES --- */
        .candlestick-chart-container {
            height: 200px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: flex-end; /* Candles rise from the bottom */
            position: relative;
            overflow: hidden;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .candlestick-bar {
            width: 3%; /* 20 bars, 5% width each */
            margin: 0 1%;
            position: relative;
            height: 100%; /* Total height for positioning */
        }
        .candlestick-bar .body {
            position: absolute;
            width: 100%;
            border: 1px solid transparent;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            border-radius: 1px;
            transition: all 0.5s ease-out; /* Smooth transitions for dynamic updates */
        }
        .candlestick-bar .wick {
            position: absolute;
            width: 1px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--text-secondary);
            transition: all 0.5s ease-out;
        }

        /* Colors for the bars */
        .body.is-green { background-color: var(--color-success); border-color: var(--color-success); }
        .body.is-red { background-color: var(--color-danger); border-color: var(--color-danger); }
        
        /* Message Box for Alerts */
        #message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            min-width: 300px;
            transition: all 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        #message-box.is-active {
            opacity: 1;
            pointer-events: auto;
        }
    </style>
</head>
<body>

    <!-- Message Box (Replaces alert()) --><div id="message-box" class="notification is-light is-rounded">
        <button class="delete"></button>
        <span id="message-content"></span>
    </div>

    <!-- Animated Background Layer --><div class="animated-background">
        <!-- Signal Stream Pillars -->
        <div class="pillar-stream"></div>
        <div class="pillar-stream"></div>
        <div class="pillar-stream"></div>
        <div class="pillar-stream"></div>
        <div class="pillar-stream"></div>
        <div class="pillar-stream"></div>

        <!-- Bunching CSS Balls -->
        <div class="data-bunch"></div>
        <div class="data-bunch"></div>
        <div class="data-bunch"></div>
        <div class="data-bunch"></div>
    </div>

    <!-- Mobile Overlay for Sidebar --><div class="mobile-overlay is-hidden-desktop" id="mobile-overlay"></div>

    <div class="dashboard-layout">
        
        <!-- Sidebar --><aside class="sidebar is-hidden-touch" id="sidebar">
            <nav class="panel">
                <p class="panel-heading has-text-primary">
                    <span class="icon is-small"><i class="fas fa-microchip"></i></span>
                    culture.support
                </p>

                <a class="panel-block is-active">
                    <span class="panel-icon"><i class="fas fa-chart-line" aria-hidden="true"></i></span>
                    Simulator Overview
                </a>
                <a class="panel-block" id="open-transfer-modal-sidebar">
                    <span class="panel-icon"><i class="fas fa-money-check-alt" aria-hidden="true"></i></span>
                    Fund Operations
                </a>
                <a class="panel-block">
                    <span class="panel-icon"><i class="fas fa-cog" aria-hidden="true"></i></span>
                    Settings
                </a>
                
                <div class="panel-block" style="flex-grow: 1;"></div>
                
                <a class="panel-block" style="margin-top: auto; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <span class="panel-icon"><i class="fas fa-sign-out-alt" aria-hidden="true"></i></span>
                    Log Out
                </a>
            </nav>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content">
            
            <!-- Top Navbar -->
            <nav class="navbar is-white has-shadow modern-card" role="navigation" style="margin-bottom: 1.5rem;">
                <div class="navbar-brand">
                    <a role="button" class="navbar-burger is-hidden-desktop" aria-label="menu" aria-expanded="false" data-target="sidebar" id="mobile-menu-toggle">
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                        <span aria-hidden="true"></span>
                    </a>
                    <span class="navbar-item is-hidden-desktop has-text-weight-bold" style="color: var(--text-light);">culture.support</span>
                </div>

                <div class="navbar-end">
                    <div class="navbar-item">
                        <div class="buttons">
                            <!-- New: Quick Run Trade Cycle Button (Now tied to signal generation) -->
                            <button class="button is-small is-primary is-rounded" id="generate-new-signal-quick">
                                <span class="icon is-small"><i class="fas fa-wave-square"></i></span>
                                <span>Generate Trade Signal</span>
                            </button>
                            <a class="button is-small is-ghost" style="color: var(--text-light);" id="open-transfer-modal-quick">
                                <span class="icon is-small"><i class="fas fa-exchange-alt"></i></span>
                                <span>Fund Ops</span>
                            </a>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- --- MODERN FINANCIAL GUI GRID LAYOUT --- -->
            <div class="columns is-multiline">
                
                <!-- COLUMN 1: BANKROLL FUND (Dynamic) -->
                <div class="column is-full-mobile is-half-tablet is-one-quarter-desktop">
                    <div class="box modern-card" style="min-height: 100%;">
                        <div class="media">
                            <div class="media-left">
                                <span class="icon is-large has-text-warning">
                                    <i class="fas fa-coins"></i>
                                </span>
                            </div>
                            <div class="media-content">
                                <p class="is-size-7" style="color: var(--text-secondary);">BANKROLL FUND (Total Capital)</p>
                                <p class="title is-3" id="bankroll-fund-value">$20,000,000</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- COLUMN 2: TOTAL PORTFOLIO VALUE (Dynamic) -->
                <div class="column is-full-mobile is-half-tablet is-one-quarter-desktop">
                    <div class="box modern-card" style="min-height: 100%;">
                        <div class="media">
                            <div class="media-content">
                                <p class="is-size-7" style="color: var(--color-primary); font-weight: 600;"><i class="fas fa-database"></i> PORTFOLIO VALUE (In-Play)</p>
                                <p class="title is-3" id="portfolio-value">$3,245,766</p> 
                                <p class="subtitle is-6 mt-1 has-text-success"><i class="fas fa-arrow-up"></i> <span id="portfolio-change">+1.25%</span> (Last Cycle)</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- COLUMN 3: HIGHEST RECORDED VALUE (Dynamic) -->
                <div class="column is-full-mobile is-half-tablet is-one-quarter-desktop">
                    <div class="box modern-card">
                        <div class="media">
                            <div class="media-left">
                                <span class="icon is-large has-text-primary">
                                    <i class="fas fa-rocket"></i>
                                </span>
                            </div>
                            <div class="media-content">
                                <p class="is-size-7" style="color: var(--text-secondary);">HIGHEST RECORDED VALUE</p>
                                <p class="title is-3" id="highest-value">$3,245,766</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- COLUMN 4: RISK INDEX (DYNAMIC GAUGE) -->
                <div class="column is-full-mobile is-half-tablet is-one-quarter-desktop">
                    <div class="box modern-card has-text-centered">
                        <p class="is-size-7" style="color: var(--text-secondary);">CURRENT RISK INDEX</p>
                        <div class="risk-gauge-wrapper mt-3">
                            <div class="risk-gauge">
                                <div class="risk-needle" id="risk-needle"></div>
                                <div class="risk-circle"></div>
                            </div>
                        </div>
                        <p class="title is-5 mt-4" id="risk-level-text">LOW RISK</p>
                    </div>
                </div>
                
                <!-- --- TRADE SIGNAL WINDOW (NEW) --- -->
                <div class="column is-full-mobile is-half-desktop">
                    <div class="box modern-card" style="min-height: 100%;">
                        <p class="title is-5 has-text-primary"><i class="fas fa-signal"></i> Trade Signal Window</p>
                        <div id="signal-display">
                            <p class="is-size-6 has-text-centered mb-2" id="signal-status" style="color: var(--color-warning);">Awaiting Next Quantum Readout...</p>
                            
                            <article class="message is-info modern-card mt-3">
                                <div class="message-header">
                                    <p id="signal-header">Signal: N/A</p>
                                </div>
                                <div class="message-body is-size-7" id="signal-details">
                                    <p><strong>Asset:</strong> <span id="signal-asset">---</span></p>
                                    <p><strong>Direction:</strong> <span id="signal-direction">---</span></p>
                                    <p><strong>Potential P&L:</strong> <span id="signal-pnl">---</span></p>
                                    <p><strong>Confidence:</strong> <span id="signal-confidence">---</span></p>
                                </div>
                            </article>
                        </div>
                        
                        <div class="has-text-centered mt-4">
                            <button class="button is-primary is-medium is-rounded" id="execute-signal-button" disabled>
                                <span class="icon"><i class="fas fa-stopwatch"></i></span>
                                <span id="execute-button-text">Generate New Signal</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- --- CANDLESTICK SIMULATOR (NEW) --- -->
                <div class="column is-full-mobile is-half-desktop">
                    <div class="box modern-card">
                        <p class="title is-5">Candlestick Price Action Simulator</p>
                        <p class="subtitle is-7">Simulated price bars reflecting trading cycles.</p>
                        <div class="candlestick-chart-container" id="candlestick-chart-container">
                            <!-- Candles will be drawn here by JS -->
                        </div>
                    </div>
                </div>

                <!-- CHART 1: TRANSACTION HISTORY -->
                <div class="column is-full-mobile is-full-desktop">
                    <div class="box modern-card">
                        <p class="title is-5">Transaction History</p>
                        <p class="subtitle is-7">Log of simulated trades, transfers, and fund debits.</p>
                        <div class="table-container modal-card-body-scroll">
                            <table class="table is-fullwidth is-hoverable is-striped">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Impact</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="transaction-history-body">
                                    <!-- Dynamic content generated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
            
            <!-- Simple Footer --><footer class="footer" style="padding: 1rem 0; background: none;">
                <div class="content has-text-centered is-size-7" style="color: var(--text-secondary);">
                    Culture Support &copy; 2025. All Rights Reserved.
                </div>
            </footer>

        </main>
    </div>
    
    <!-- Fund Operations Modal (Existing) -->
    <div class="modal" id="fund-ops-modal">
        <div class="modal-background"></div>
        <div class="modal-card modern-card" style="width: 90%; max-width: 600px;">
            <header class="modal-card-head" style="background: var(--dark-bg-secondary); border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <p class="modal-card-title has-text-light">Fund Operations: Transfer & Payout</p>
                <button class="delete" aria-label="close" id="close-modal-button"></button>
            </header>
            <section class="modal-card-body" style="background: var(--glass-bg);">
                <div class="field">
                    <label class="label has-text-light">Amount (USD)</label>
                    <div class="control">
                        <input class="input" type="number" id="transfer-amount-input" placeholder="e.g., 500000" min="1000">
                    </div>
                    <p class="help" style="color: var(--text-secondary);">Enter the amount to transfer or payout.</p>
                </div>

                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-success" id="transfer-in-button">
                            <span class="icon"><i class="fas fa-arrow-alt-circle-down"></i></span>
                            <span>TRANSFER IN (Add to Bankroll)</span>
                        </button>
                    </div>
                    <div class="control">
                        <button class="button is-danger" id="payout-button">
                            <span class="icon"><i class="fas fa-arrow-alt-circle-up"></i></span>
                            <span>PAYOUT (Debit Bankroll)</span>
                        </button>
                    </div>
                </div>

                <div class="field mt-5">
                    <label class="label has-text-light">Run Signal Trade</label>
                    <p class="help" style="color: var(--text-secondary);">Use the main Trade Signal Window to execute a signal.</p>
                    <button class="button is-primary is-fullwidth mt-3" id="generate-new-signal-modal">
                        <span class="icon"><i class="fas fa-bolt"></i></span>
                        <span>Generate New Trade Signal</span>
                    </button>
                </div
                
                <article class="message is-info mt-4 modern-card" style="background: rgba(50, 115, 220, 0.2); border-left: 5px solid var(--color-primary);">
                    <div class="message-body has-text-light is-size-7">
                        Current Bankroll: <span class="has-text-weight-bold" id="modal-bankroll-display">$20,000,000</span>
                    </div>
                </article>
            </section>
        </div>
    </div>

    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- SIMULATOR STATE ---
            let bankrollFund = 20000000.00; // Initial $20,000,000
            let portfolioValue = 3245766.00; 
            let highestValue = 3245766.00;
            let lastPnl = 0.00;
            let transactionIdCounter = 1;
            let currentSignal = null;
            const ASSETS = ['TSLA', 'GOOGL', 'NVDA', 'AMZN', 'AAPL', 'MSFT', 'META'];

            // --- DOM ELEMENTS ---
            const bankrollEl = document.getElementById('bankroll-fund-value');
            const portfolioEl = document.getElementById('portfolio-value');
            const highestValueEl = document.getElementById('highest-value');
            const portfolioChangeEl = document.getElementById('portfolio-change');
            const txHistoryBodyEl = document.getElementById('transaction-history-body');
            const modalBankrollDisplayEl = document.getElementById('modal-bankroll-display');
            
            // Signal Elements
            const signalStatusEl = document.getElementById('signal-status');
            const signalHeaderEl = document.getElementById('signal-header');
            const signalAssetEl = document.getElementById('signal-asset');
            const signalDirectionEl = document.getElementById('signal-direction');
            const signalPnlEl = document.getElementById('signal-pnl');
            const signalConfidenceEl = document.getElementById('signal-confidence');
            const executeSignalButton = document.getElementById('execute-signal-button');
            const executeButtonTextEl = document.getElementById('execute-button-text');
            const generateNewSignalQuickButton = document.getElementById('generate-new-signal-quick');
            const generateNewSignalModalButton = document.getElementById('generate-new-signal-modal');
            const candlestickContainer = document.getElementById('candlestick-chart-container');
            
            // Message Box
            const messageBox = document.getElementById('message-box');
            const messageContent = document.getElementById('message-content');
            messageBox.querySelector('.delete').addEventListener('click', () => {
                messageBox.classList.remove('is-active');
            });
            
            // --- HELPER FUNCTIONS ---

            /** Displays a custom message box notification. */
            function showMessage(message, type = 'is-info') {
                messageBox.className = 'notification is-light is-rounded is-active';
                messageBox.classList.add(type);
                messageContent.textContent = message;
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    messageBox.classList.remove('is-active');
                }, 5000);
            }

            /** Formats a number to USD currency string. */
            function formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(amount);
            }
            
            /** Updates all dashboard display metrics based on current state. */
            function updateDisplay() {
                bankrollEl.textContent = formatCurrency(bankrollFund);
                portfolioEl.textContent = formatCurrency(portfolioValue);
                highestValueEl.textContent = formatCurrency(highestValue);
                modalBankrollDisplayEl.textContent = formatCurrency(bankrollFund);

                const prevPortfolioValue = portfolioValue - lastPnl;
                const changePercent = (lastPnl / prevPortfolioValue) * 100;

                // Portfolio Change Indicator
                portfolioChangeEl.textContent = isNaN(changePercent) || prevPortfolioValue === 0 ? 'N/A' : `${lastPnl >= 0 ? '+' : ''}${changePercent.toFixed(2)}%`;
                
                const portfolioChangeIcon = portfolioChangeEl.parentElement.querySelector('i');
                portfolioChangeEl.classList.remove('has-text-success', 'has-text-danger', 'has-text-secondary');

                if (lastPnl > 0) {
                    portfolioChangeEl.classList.add('has-text-success');
                    portfolioChangeIcon.className = 'fas fa-arrow-up';
                } else if (lastPnl < 0) {
                    portfolioChangeEl.classList.add('has-text-danger');
                    portfolioChangeIcon.className = 'fas fa-arrow-down';
                } else {
                    portfolioChangeEl.classList.add('has-text-secondary');
                    portfolioChangeIcon.className = 'fas fa-minus';
                }
            }

            /** Adds a transaction entry to the history table. */
            function addTransaction(type, amount, statusClass, impactText) {
                const newRow = txHistoryBodyEl.insertRow(0); // Insert at the top
                const date = new Date().toLocaleTimeString();
                
                // Add tag styles
                let tagClass = 'is-light';
                if (statusClass.includes('success')) tagClass += ' is-success';
                else if (statusClass.includes('danger')) tagClass += ' is-danger';
                else tagClass += ' is-info';

                newRow.innerHTML = `
                    <td>#${transactionIdCounter++}</td>
                    <td><span class="tag ${tagClass}">${type}</span></td>
                    <td class="has-text-weight-bold">${formatCurrency(amount)}</td>
                    <td class="${statusClass}">${impactText}</td>
                    <td>${date}</td>
                `;
            }
            
            // --- CANDLESTICK SIMULATOR CORE ---
            let candlestickData = []; // Stores the closing prices for simulation

            function drawCandlestickSim() {
                candlestickContainer.innerHTML = ''; // Clear previous

                // The candle data is derived from the last 20 P&L settlements
                const dataToDraw = candlestickData.slice(-20);
                const containerHeight = 200;
                
                if (dataToDraw.length === 0) return;

                // Find min/max for scaling
                const allValues = [].concat(...dataToDraw.map(d => [d.open, d.high, d.low, d.close]));
                const minPrice = Math.min(...allValues) - 100000; 
                const maxPrice = Math.max(...allValues) + 100000;
                const priceRange = maxPrice - minPrice;

                dataToDraw.forEach((data, i) => {
                    const isGreen = data.close >= data.open;
                    
                    // Normalize prices to pixel values (0 to containerHeight)
                    const normHigh = (data.high - minPrice) / priceRange * containerHeight;
                    const normLow = (data.low - minPrice) / priceRange * containerHeight;
                    const normOpen = (data.open - minPrice) / priceRange * containerHeight;
                    const normClose = (data.close - minPrice) / priceRange * containerHeight;

                    // Calculate positions from the top (since CSS coordinates start at 0 top)
                    const bodyTop = containerHeight - Math.max(normOpen, normClose);
                    const bodyHeight = Math.abs(normOpen - normClose);
                    const wickTop = containerHeight - normHigh;
                    const wickHeight = normHigh - normLow; 

                    // Create Bar Element
                    const bar = document.createElement('div');
                    bar.className = 'candlestick-bar';
                    bar.style.left = `${5 * i + 2}%`; // 5% width, 1% margin
                    bar.style.transform = 'translateY(0)'; // Reset transform

                    const wickStyle = `top: ${wickTop}px; height: ${wickHeight}px;`;
                    const bodyStyle = `
                        top: ${bodyTop}px; 
                        height: ${Math.max(3, bodyHeight)}px; /* Ensure minimum height */
                        background-color: ${isGreen ? 'var(--color-success)' : 'var(--color-danger)'};
                    `;

                    bar.innerHTML = `
                        <div class="wick" style="${wickStyle}"></div>
                        <div class="body ${isGreen ? 'is-green' : 'is-red'}" style="${bodyStyle}"></div>
                    `;

                    candlestickContainer.appendChild(bar);
                });
            }

            /** Generates a simple OHLC data point based on the last PNL. */
            function generateCandleData(pnl) {
                const lastClose = candlestickData.length > 0 ? candlestickData[candlestickData.length - 1].close : portfolioValue;
                const open = lastClose + (Math.random() * 50000 - 25000); // Small volatility
                const close = open + pnl * 0.1; // PNL dictates direction, scale factor
                
                const high = Math.max(open, close) + Math.abs(pnl * 0.05) + Math.random() * 10000;
                const low = Math.min(open, close) - Math.abs(pnl * 0.05) - Math.random() * 10000;

                const newCandle = {
                    open: Math.round(open),
                    close: Math.round(close),
                    high: Math.round(high),
                    low: Math.round(low)
                };
                
                candlestickData.push(newCandle);
                if (candlestickData.length > 30) candlestickData.shift(); // Keep history manageable
                drawCandlestickSim();
            }

            // --- SIMULATOR CORE LOGIC ---

            /** Generates simulated P&L for a trade cycle, potentially biased by a signal. */
            function runTradeCycle(signalPnlFactor = 1.0) {
                // Determine base PNL (Max of 5% of Portfolio Value)
                const basePnl = portfolioValue * (Math.random() * 0.10 - 0.05); 
                
                let pnl = basePnl * signalPnlFactor;

                // Random high volatility scenario overrides
                const random = Math.random();
                if (random < 0.05) { // High Income (5-10% gain)
                    pnl = portfolioValue * (0.05 + Math.random() * 0.05) * signalPnlFactor;
                } else if (random > 0.95) { // Negative Loss (-5% to -10% loss)
                    pnl = -portfolioValue * (0.05 + Math.random() * 0.05) * signalPnlFactor;
                }
                
                const pnlRounded = Math.round(pnl * 100) / 100;

                // 1. Update Portfolio Value (P&L added to in-play capital)
                portfolioValue += pnlRounded;
                portfolioValue = Math.max(0, portfolioValue); 

                // 2. Settle P&L against Bankroll (Debit/Credit the main fund)
                bankrollFund += pnlRounded;
                
                // 3. Update Highest Recorded Value
                if (portfolioValue > highestValue) {
                    highestValue = portfolioValue;
                }

                // 4. Log Transaction
                lastPnl = pnlRounded;
                const statusClass = pnlRounded >= 0 ? 'has-text-success' : 'has-text-danger';
                const impactText = pnlRounded >= 0 ? 'Investment Credit Resultat' : 'Investment Debit Resultat';
                addTransaction('TRADE SETTLEMENT', Math.abs(pnlRounded), statusClass, impactText);
                
                // 5. Generate Candlestick Data
                generateCandleData(pnlRounded);

                // 6. Update UI
                updateDisplay();
                return { pnl: pnlRounded, statusClass };
            }

            // --- FUND OPERATIONS (Existing) ---
            function handleTransfer(amount) {
                if (amount <= 0) { showMessage('Please enter a valid transfer amount.', 'is-danger'); return; }
                bankrollFund += amount;
                addTransaction('TRANSFER IN', amount, 'has-text-success', 'Capital Added');
                updateDisplay();
                showMessage(`Successfully transferred ${formatCurrency(amount)} into the Bankroll Fund.`, 'is-success');
            }

            function handlePayout(amount) {
                if (amount <= 0) { showMessage('Please enter a valid payout amount.', 'is-danger'); return; }
                if (amount > bankrollFund) {
                    showMessage(`ERROR: Payout amount (${formatCurrency(amount)}) exceeds available Bankroll Fund (${formatCurrency(bankrollFund)}).`, 'is-danger');
                    return;
                }

                bankrollFund -= amount;
                addTransaction('PAYOUT', amount, 'has-text-danger', 'Capital Debited');
                updateDisplay();
                showMessage(`Successfully processed payout of ${formatCurrency(amount)} from Bankroll Fund.`, 'is-success');
            }

            // --- TRADE SIGNAL LOGIC (NEW) ---
            
            function generateTradeSignal() {
                executeSignalButton.disabled = true;
                executeButtonTextEl.textContent = 'Generating...';
                
                const direction = Math.random() > 0.5 ? 'LONG (Buy)' : 'SHORT (Sell)';
                const asset = ASSETS[Math.floor(Math.random() * ASSETS.length)];
                
                // PNL potential is based on a fraction of portfolio value, with volatility
                const pnlPotential = portfolioValue * (Math.random() * 0.03 + 0.005); 
                const confidenceRaw = Math.random();
                const confidence = (confidenceRaw * 40 + 60).toFixed(1); // 60% to 100%

                // Bias the outcome based on confidence and direction
                const pnlFactor = direction === 'LONG (Buy)' ? (confidenceRaw + 0.5) : 1 - confidenceRaw;
                
                currentSignal = { direction, asset, pnlPotential: Math.round(pnlPotential), pnlFactor };

                signalStatusEl.textContent = 'QUANTUM READOUT COMPLETE';
                signalStatusEl.classList.remove('has-text-warning');
                signalStatusEl.classList.add('has-text-success');

                signalHeaderEl.textContent = `Signal: ${currentSignal.direction} ${currentSignal.asset}`;
                signalAssetEl.textContent = currentSignal.asset;
                signalDirectionEl.textContent = currentSignal.direction;
                signalPnlEl.textContent = `~${formatCurrency(currentSignal.pnlPotential)}`;
                signalConfidenceEl.textContent = `${confidence}%`;

                // Set up the "call delay" mechanism
                executeButtonTextEl.textContent = 'Executing in 3...';
                let countdown = 3;
                
                const countdownTimer = setInterval(() => {
                    countdown--;
                    executeButtonTextEl.textContent = `Executing in ${countdown}...`;
                    if (countdown <= 0) {
                        clearInterval(countdownTimer);
                        executeButtonTextEl.textContent = 'Execute Trade Now';
                        executeSignalButton.disabled = false;
                        showMessage(`Signal generated: ${direction} ${asset}. Click "Execute Trade Now" before the market moves!`, 'is-warning');
                    }
                }, 1000);
            }

            function executeTradeSignal() {
                if (!currentSignal) { 
                    showMessage('ERROR: Please generate a signal first.', 'is-danger');
                    return;
                }
                
                executeSignalButton.disabled = true;
                executeButtonTextEl.textContent = 'Executing Trade...';
                
                // Run the core trade cycle, applying the signal's P&L factor
                const result = runTradeCycle(currentSignal.pnlFactor);

                signalStatusEl.textContent = 'TRADE EXECUTED';
                signalStatusEl.classList.remove('has-text-success');
                signalStatusEl.classList.add('has-text-info');
                
                let tradeMessage;
                if (result.pnl > 0) {
                    tradeMessage = `SUCCESS: Trade settled with a gain of ${formatCurrency(result.pnl)}.`;
                } else {
                    tradeMessage = `LOSS: Trade settled with a loss of ${formatCurrency(Math.abs(result.pnl))}.`;
                }
                
                showMessage(tradeMessage, result.statusClass.replace('has-text-', 'is-'));

                // Reset signal state after execution
                currentSignal = null;
                executeButtonTextEl.textContent = 'Generate New Signal';
                executeSignalButton.disabled = false;
                
                // Clear signal details for next run
                setTimeout(() => {
                    signalStatusEl.textContent = 'Awaiting Next Quantum Readout...';
                    signalStatusEl.classList.remove('has-text-info');
                    signalStatusEl.classList.add('has-text-warning');
                    signalHeaderEl.textContent = `Signal: N/A`;
                    signalAssetEl.textContent = '---';
                    signalDirectionEl.textContent = '---';
                    signalPnlEl.textContent = '---';
                    signalConfidenceEl.textContent = '---';
                }, 5000);
            }

            // --- UI EVENT HANDLERS ---
            
            // Modal Elements
            const modal = document.getElementById('fund-ops-modal');
            const transferInput = document.getElementById('transfer-amount-input');
            
            // Buttons
            const openModalButtons = document.querySelectorAll('#open-transfer-modal-sidebar, #open-transfer-modal-quick, #open-transfer-modal-main');
            const closeModalButton = document.getElementById('close-modal-button');
            const transferInButton = document.getElementById('transfer-in-button');
            const payoutButton = document.getElementById('payout-button');

            // Signal Button Handlers
            generateNewSignalQuickButton.addEventListener('click', generateTradeSignal);
            generateNewSignalModalButton.addEventListener('click', generateTradeSignal);
            executeSignalButton.addEventListener('click', executeTradeSignal);


            // Open Modal
            openModalButtons.forEach(btn => btn.addEventListener('click', () => {
                modal.classList.add('is-active');
                transferInput.value = ''; // Clear input on open
                updateDisplay(); // Refresh bankroll display in modal
            }));

            // Close Modal
            closeModalButton.addEventListener('click', () => {
                modal.classList.remove('is-active');
            });
            modal.querySelector('.modal-background').addEventListener('click', () => {
                modal.classList.remove('is-active');
            });

            // Handle Fund Transfers
            transferInButton.addEventListener('click', () => {
                const amount = parseFloat(transferInput.value);
                if (!isNaN(amount)) {
                    handleTransfer(amount);
                    transferInput.value = '';
                }
            });

            payoutButton.addEventListener('click', () => {
                const amount = parseFloat(transferInput.value);
                if (!isNaN(amount)) {
                    handlePayout(amount);
                    transferInput.value = '';
                }
            });

            // --- Mobile Menu Toggle Logic (Existing) ---
            const $navbarBurger = document.getElementById('mobile-menu-toggle');
            const $sidebar = document.getElementById('sidebar');
            const $overlay = document.getElementById('mobile-overlay');

            if ($navbarBurger && $sidebar && $overlay) {
                const toggleMenu = () => {
                    $sidebar.classList.toggle('is-active');
                    $overlay.classList.toggle('is-active');
                };

                $navbarBurger.addEventListener('click', toggleMenu);
                $overlay.addEventListener('click', toggleMenu);
            }

            // --- DYNAMIC RISK GAUGE LOGIC (Existing) ---
            const riskNeedle = document.getElementById('risk-needle');
            const riskLevelText = document.getElementById('risk-level-text');

            function updateRiskGauge() {
                const riskValue = Math.floor(Math.random() * 100); 

                let riskText = 'CALCULATING...';
                let textColorClass = 'has-text-secondary';
                
                if (riskValue <= 40) {
                    riskText = 'LOW RISK';
                    textColorClass = 'has-text-risk-low';
                } else if (riskValue <= 75) {
                    riskText = 'MODERATE RISK';
                    textColorClass = 'has-text-risk-moderate';
                } else {
                    riskText = 'HIGH RISK';
                    textColorClass = 'has-text-risk-high';
                }

                const rotationDegrees = 165 - (riskValue * 1.2); 

                if (riskNeedle) {
                    riskNeedle.style.transform = `translateX(-50%) rotate(${rotationDegrees}deg)`;
                }

                if (riskLevelText) {
                    riskLevelText.classList.remove('has-text-risk-low', 'has-text-risk-moderate', 'has-text-risk-high', 'has-text-secondary');
                    riskLevelText.textContent = riskText;
                    riskLevelText.classList.add(textColorClass);
                }
            }

            // --- INITIALIZATION ---
            updateRiskGauge();
            setInterval(updateRiskGauge, 4000); 
            
            // Initial Candlestick Data (Random walk start)
            let initialClose = portfolioValue;
            for (let i = 0; i < 20; i++) {
                const open = initialClose + (Math.random() * 100000 - 50000);
                const close = open + (Math.random() * 50000 - 25000);
                const high = Math.max(open, close) + Math.random() * 10000;
                const low = Math.min(open, close) - Math.random() * 10000;
                 candlestickData.push({ open, close, high, low });
                initialClose = close;
            }


            // Set initial last P&L to 0 and update display
            lastPnl = 0;
            updateDisplay();
            drawCandlestickSim();
            addTransaction('INIT', bankrollFund + portfolioValue, 'has-text-primary', 'Simulator Initialized');
            
            // Set initial signal button text
            executeButtonTextEl.textContent = 'Generate New Signal';
            executeSignalButton.disabled = false;
        });
    </script>
</body>
</html>

