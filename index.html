<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Culture.Support</title>
    <!-- Tailwind CSS CDN for modern utility styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bulma CSS CDN for structure (using a custom theme style below) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/css.min.css">
    <!-- Tone.js CDN for audio synthesis and sequencing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Custom Dark Theme and Font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #c9d1d9; /* Light text */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 1200px;
            padding: 2rem;
        }

        .box {
            background-color: #161b22; /* Darker box */
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid #30363d;
        }

        .title, .subtitle {
            color: #58a6ff !important; /* Blue accent color */
            font-weight: 800;
        }

        /* Sequencer Grid Styling */
        .looper-wrapper {
            overflow-x: auto; /* Allows scrolling on smaller screens */
            padding: 8px 0;
        }

        .looper-grid {
            display: grid;
            grid-template-columns: repeat(32, 1fr); /* 32 steps */
            gap: 2px; /* Smaller gap for 32 steps */
            padding: 4px;
            background-color: #0d1117;
            border-radius: 8px;
            min-width: 1000px; /* Ensure it's wide enough */
        }

        .step-button {
            height: 25px;
            background-color: #30363d; /* Off state */
            border: none;
            border-radius: 3px;
            transition: background-color 0.1s ease;
            cursor: pointer;
        }

        .step-button:hover {
            background-color: #58a6ff;
        }

        .step-button.active {
            background-color: #39cc68; /* On state (Green) */
            box-shadow: 0 0 5px rgba(57, 204, 104, 0.6);
        }

        .step-button.playing {
            /* Highlight column currently playing */
            border: 2px solid #ff7b72;
            transform: scale(1.05);
        }

        /* Bulma button overrides for theme */
        .button {
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .is-primary {
            background-color: #58a6ff;
            border-color: #58a6ff;
            color: #0d1117;
        }

        .is-primary:hover {
            background-color: #79c0ff;
        }

        .is-danger {
            background-color: #ff7b72;
        }
        .is-danger:hover {
            background-color: #ffa19c;
        }

        /* Chord Display */
        #chord-display {
            font-size: 2rem;
            font-weight: 800;
            color: #39cc68;
            margin-bottom: 1rem;
            text-align: center;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
             .looper-grid {
                /* Let the horizontal scroll handle smaller screens */
                min-width: 800px;
            }
        }
    </style>
</head>
<body>

    <div class="container is-fluid">
        <div class="box">
            <h1 class="title is-3 has-text-centered">Generative Music Pad (32 Steps)</h1>
            <p class="subtitle is-6 has-text-centered mb-5">
                Chord Generator & Extended Step Sequencer (32 Steps)
            </p>

            <!-- Chord Generator Panel -->
            <div class="mb-5 p-4 bg-gray-900 rounded-lg">
                <h3 class="subtitle is-5 mb-3 has-text-centered">Current Harmony</h3>
                <div id="chord-display">C Major (C4, E4, G4)</div>
                <div class="has-text-centered">
                    <button id="generate-chord-btn" class="button is-primary is-outlined">
                        Generate New Chord & Play
                    </button>
                    <button id="play-chord-btn" class="button is-info is-outlined ml-3">
                        Play Chord
                    </button>
                </div>
            </div>

            <!-- Looper/Sequencer Panel -->
            <h3 class="subtitle is-5 mb-3 has-text-centered mt-6">Looper Sequencer (32 Steps)</h3>

            <!-- Looper Grid Wrapper (for scrolling) -->
            <div class="looper-wrapper mb-5">
                <div id="looper-grid" class="looper-grid">
                    <!-- Buttons will be inserted here by JavaScript -->
                </div>
            </div>

            <!-- Controls Panel -->
            <div id="controls-panel" class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <button id="start-stop-btn" class="button is-success is-large">
                    <span id="start-stop-text">Start Looper</span>
                </button>
                <button id="new-sequence-btn" class="button is-link">
                    New Melody/Beat
                </button>
                <button id="clear-track-btn" class="button is-danger is-outlined">
                    Clear Track
                </button>
                <div class="field is-grouped">
                    <p class="control is-expanded">
                        <input id="tempo-input" class="input bg-gray-700 text-white rounded-r-none" type="number" placeholder="BPM" value="120" min="40" max="240">
                    </p>
                    <p class="control">
                        <button id="set-tempo-btn" class="button is-dark rounded-l-none">Set BPM</button>
                    </p>
                </div>
            </div>
            
            <!-- MIDI Download Button -->
            <div class="has-text-centered mt-4">
                 <button id="download-midi-btn" class="button is-warning is-outlined">
                    Download MIDI (Ableton Compatible)
                </button>
            </div>
            
            <p class="mt-4 has-text-centered is-size-7 text-gray-400" id="status-message">
                Click 'Start Looper' to initialize and begin playback.
            </p>
        </div>
    </div>

    <script>
        // --- Global Variables and Configuration ---
        const STEPS = 32; // Updated from 16 to 32
        const ROWS = 4;
        const GRID_NOTES = ['C5', 'G4', 'E4', 'C4']; // Top to bottom notes
        const CHORD_INTERVALS = {
            'Major': [0, 4, 7],
            'Minor': [0, 3, 7],
            '7th': [0, 4, 7, 10]
        };
        const ROOT_NOTES = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];

        let isPlaying = false;
        let looperGridState = []; // 2D array: ROWS x STEPS
        let currentStep = -1;
        let sequencer = null;
        let polySynth = null;
        let chordSynth = null;
        let ppqn = 96; // Pulses Per Quarter Note (Standard MIDI resolution)

        // --- Tone.js Initialization Functions ---

        // Initialize synthesizers and Tone Transport
        function initAudio() {
            if (polySynth && chordSynth) return;

            polySynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: 'triangle' },
                envelope: {
                    attack: 0.005,
                    decay: 0.1,
                    sustain: 0.3,
                    release: 1
                }
            }).toDestination();

            chordSynth = new Tone.PolySynth(Tone.AMSynth, {
                volume: -6,
                oscillator: { type: 'sine' },
                envelope: {
                    attack: 0.2,
                    decay: 0.5,
                    sustain: 0.5,
                    release: 2
                }
            }).toDestination();

            Tone.Transport.bpm.value = document.getElementById('tempo-input').value || 120;
            document.getElementById('status-message').textContent = "Audio ready. Click 'Start Looper' to play.";
        }
        
        // --- Sequencer Grid Management ---

        function setupGrid() {
            const gridContainer = document.getElementById('looper-grid');
            gridContainer.innerHTML = '';
            looperGridState = [];

            for (let r = 0; r < ROWS; r++) {
                looperGridState[r] = [];
                for (let c = 0; c < STEPS; c++) {
                    looperGridState[r][c] = false;

                    const button = document.createElement('button');
                    button.className = 'step-button';
                    button.dataset.row = r;
                    button.dataset.col = c;
                    button.title = GRID_NOTES[r] + ' at step ' + (c + 1);

                    // Add visual grouping for every 8th note (2 steps)
                    if (c % 8 === 0) {
                         button.style.borderLeft = '1px solid #30363d';
                    }
                    if (c % 4 === 0 && c % 8 !== 0) {
                         button.style.borderLeft = '1px solid #161b22';
                    }

                    // Add color hint for rows (optional aesthetic)
                    if (r === 0) button.style.backgroundColor = '#4e405a'; 
                    else if (r === 1) button.style.backgroundColor = '#3d4a65';
                    else if (r === 2) button.style.backgroundColor = '#385d56';
                    else button.style.backgroundColor = '#4a3d3d';


                    button.addEventListener('click', () => {
                        looperGridState[r][c] = !looperGridState[r][c];
                        button.classList.toggle('active', looperGridState[r][c]);
                    });

                    gridContainer.appendChild(button);
                }
            }
            generateNewSequence();
        }

        // Fills the grid with a random, sparse beat/melody
        function generateNewSequence() {
            const buttons = document.querySelectorAll('.step-button');
            buttons.forEach(btn => {
                const r = parseInt(btn.dataset.row);
                const c = parseInt(btn.dataset.col);

                const isActive = Math.random() < 0.1; // Lower chance for sparse 32-step loop
                looperGridState[r][c] = isActive;
                btn.classList.toggle('active', isActive);
                
                // Reset color hints
                if (!isActive) {
                    if (r === 0) btn.style.backgroundColor = '#4e405a';
                    else if (r === 1) btn.style.backgroundColor = '#3d4a65';
                    else if (r === 2) btn.style.backgroundColor = '#385d56';
                    else btn.style.backgroundColor = '#4a3d3d';
                } else {
                    btn.style.backgroundColor = ''; // Use default active color
                }
            });
        }
        
        // --- Tone.js Sequencer Logic ---

        function setupSequencer() {
            if (sequencer) {
                sequencer.dispose();
            }

            // Create a sequence that advances every 16th note (32 steps = 8 beats)
            sequencer = new Tone.Sequence((time, step) => {
                // Remove playing highlight from previous step
                if (currentStep !== -1) {
                    document.querySelectorAll(`[data-col="${currentStep}"]`).forEach(btn => btn.classList.remove('playing'));
                }

                currentStep = step;

                // Add playing highlight to current step
                document.querySelectorAll(`[data-col="${currentStep}"]`).forEach(btn => btn.classList.add('playing'));


                const notesToPlay = [];
                for (let r = 0; r < ROWS; r++) {
                    if (looperGridState[r][step]) {
                        notesToPlay.push(GRID_NOTES[r]);
                    }
                }

                if (notesToPlay.length > 0) {
                    // Play all notes scheduled for this step, duration is 16th note
                    polySynth.triggerAttackRelease(notesToPlay, '16n', time, 0.5); // 0.5 velocity
                }

            }, Array.from({ length: STEPS }, (_, i) => i), '16n'); // 16n is the step resolution

            sequencer.start(0);
        }

        // --- Chord Generator Logic (Unchanged) ---

        function generateRandomChord() {
            const root = ROOT_NOTES[Math.floor(Math.random() * ROOT_NOTES.length)];
            const chordTypes = Object.keys(CHORD_INTERVALS);
            const type = chordTypes[Math.floor(Math.random() * chordTypes.length)];
            const intervals = CHORD_INTERVALS[type];

            const rootMidi = Tone.Frequency(root + '4').toMidi();
            const chordNotes = intervals.map(interval => {
                const midiNote = rootMidi + interval;
                return Tone.Midi.mtoa(midiNote);
            });

            return {
                name: `${root} ${type}`,
                notes: chordNotes
            };
        }

        function playAndDisplayChord(newChord = null) {
            const chord = newChord || generateRandomChord();
            
            document.getElementById('chord-display').textContent = 
                `${chord.name} (${chord.notes.join(', ')})`;

            if (chordSynth) {
                chordSynth.triggerAttackRelease(chord.notes, '1n', Tone.now(), 0.8); 
            }
            
            return chord;
        }


        // --- MIDI Download Logic ---

        // Helper function to write a 4-byte string to buffer
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
            return offset + string.length;
        }

        // Helper function to write a 32-bit integer (big-endian)
        function writeUint32(view, offset, value) {
            view.setUint32(offset, value, false); // false for big-endian
            return offset + 4;
        }

        // Helper function to write a 16-bit integer (big-endian)
        function writeUint16(view, offset, value) {
            view.setUint16(offset, value, false);
            return offset + 2;
        }
        
        // Helper for Variable Length Quantity (VLQ - for delta time)
        function writeVLQ(view, offset, value) {
            let buffer = value & 0x7F;
            let temp = value >> 7;
            while (temp > 0) {
                buffer = (buffer << 8) | ((temp & 0x7F) | 0x80);
                temp >>= 7;
            }
            let bytes = [];
            while (true) {
                bytes.push(buffer & 0xFF);
                if (buffer & 0x80) {
                    buffer >>= 8;
                } else {
                    break;
                }
            }
            bytes.reverse();
            bytes.forEach(byte => {
                view.setUint8(offset, byte);
                offset++;
            });
            return offset;
        }

        function generateMidiFile() {
            const midiEvents = [];
            const ticksPerStep = ppqn / 4; // 16th note resolution (Quarter note / 4)
            const noteDurationTicks = ticksPerStep * 0.9; // Slightly less than a full step

            // 1. Convert grid to MIDI events
            for (let c = 0; c < STEPS; c++) {
                const stepTick = c * ticksPerStep;
                for (let r = 0; r < ROWS; r++) {
                    if (looperGridState[r][c]) {
                        const note = Tone.Frequency(GRID_NOTES[r]).toMidi();
                        const velocity = 100; // Fixed velocity

                        // Note ON Event
                        midiEvents.push({
                            tick: stepTick,
                            status: 0x90, // Note On (Channel 1)
                            data1: note,
                            data2: velocity
                        });

                        // Note OFF Event
                        midiEvents.push({
                            tick: stepTick + noteDurationTicks,
                            status: 0x80, // Note Off (Channel 1)
                            data1: note,
                            data2: 0 // Velocity 0
                        });
                    }
                }
            }
            
            // Sort events by time
            midiEvents.sort((a, b) => a.tick - b.tick);

            // 2. Build MIDI Track Chunk (MTrk)
            let trackLength = 0;
            const trackBuffer = [];
            let currentTick = 0;

            // Set Tempo (Meta Event 0x51)
            // Microseconds per quarter note: 60,000,000 / BPM
            const bpm = parseInt(document.getElementById('tempo-input').value) || 120;
            const mpqn = Math.floor(60000000 / bpm);
            
            // Delta time (0)
            trackBuffer.push(0x00);
            // Meta event marker
            trackBuffer.push(0xFF);
            // Tempo event type
            trackBuffer.push(0x51);
            // Data length (3 bytes)
            trackBuffer.push(0x03);
            // MPQN data (3 bytes)
            trackBuffer.push((mpqn >> 16) & 0xFF, (mpqn >> 8) & 0xFF, mpqn & 0xFF);

            // 3. Process Note Events
            midiEvents.forEach(event => {
                const deltaTime = Math.round(event.tick - currentTick);
                currentTick = Math.round(event.tick);

                // For simplicity, we write delta time using the VLQ helper later
                const tempBuffer = [];
                let tempOffset = 0;
                const tempView = new DataView(new ArrayBuffer(5)); // Max VLQ is 5 bytes

                tempOffset = writeVLQ(tempView, tempOffset, deltaTime);
                for(let i = 0; i < tempOffset; i++) {
                    trackBuffer.push(tempView.getUint8(i));
                }

                // Status Byte
                trackBuffer.push(event.status);
                // Data Bytes
                trackBuffer.push(event.data1, event.data2);
            });

            // Track End (Meta Event 0x2F)
            trackBuffer.push(0x00); // Delta time (0)
            trackBuffer.push(0xFF); // Meta event marker
            trackBuffer.push(0x2F); // End of Track event type
            trackBuffer.push(0x00); // Data length (0 bytes)
            
            trackLength = trackBuffer.length;
            
            // 4. Build Final MIDI File ArrayBuffer
            // MThd (Header): 14 bytes
            // MTrk (Track): 8 + trackLength bytes
            const totalSize = 14 + 8 + trackLength;
            const buffer = new ArrayBuffer(totalSize);
            const view = new DataView(buffer);
            let offset = 0;

            // MThd Chunk
            offset = writeString(view, offset, 'MThd'); // Chunk ID
            offset = writeUint32(view, offset, 6);       // Length (6 bytes)
            offset = writeUint16(view, offset, 0);       // Format (Type 0: Single Track)
            offset = writeUint16(view, offset, 1);       // Num Tracks (1)
            offset = writeUint16(view, offset, ppqn);    // Division (Ticks per Quarter Note)

            // MTrk Chunk
            offset = writeString(view, offset, 'MTrk'); // Chunk ID
            offset = writeUint32(view, offset, trackLength); // Length of track data

            // Write Track Data
            trackBuffer.forEach(byte => {
                view.setUint8(offset, byte);
                offset++;
            });

            // 5. Download the file
            const blob = new Blob([buffer], { type: 'audio/midi' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Generative_Looper_32_Step.mid';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.getElementById('status-message').textContent = 'MIDI file successfully generated and downloaded!';
        }

        // --- Event Listeners and Control Functions ---

        document.getElementById('start-stop-btn').addEventListener('click', async () => {
            await initAudio(); 

            if (Tone.context.state !== 'running') {
                await Tone.context.resume();
            }

            if (isPlaying) {
                Tone.Transport.pause();
                document.getElementById('start-stop-text').textContent = 'Start Looper';
                document.getElementById('start-stop-btn').classList.replace('is-danger', 'is-success');
                isPlaying = false;
                document.querySelectorAll('.step-button').forEach(btn => btn.classList.remove('playing'));
                currentStep = -1;
                document.getElementById('status-message').textContent = 'Looper stopped.';

            } else {
                setupSequencer();
                Tone.Transport.start();
                document.getElementById('start-stop-text').textContent = 'Stop Looper';
                document.getElementById('start-stop-btn').classList.replace('is-success', 'is-danger');
                isPlaying = true;
                document.getElementById('status-message').textContent = `Looper running at ${Tone.Transport.bpm.value} BPM.`;
            }
        });

        document.getElementById('generate-chord-btn').addEventListener('click', () => {
            initAudio();
            playAndDisplayChord();
        });
        
        document.getElementById('play-chord-btn').addEventListener('click', () => {
            initAudio();
            const display = document.getElementById('chord-display').textContent;
            const match = display.match(/\((.*?)\)/);
            if (match) {
                const notes = match[1].split(',').map(n => n.trim());
                if (chordSynth) {
                    chordSynth.triggerAttackRelease(notes, '1n', Tone.now(), 0.8);
                }
            } else {
                playAndDisplayChord();
            }
        });

        document.getElementById('new-sequence-btn').addEventListener('click', () => {
            generateNewSequence();
        });

        document.getElementById('clear-track-btn').addEventListener('click', () => {
            document.querySelectorAll('.step-button.active').forEach(btn => {
                btn.click();
            });
            document.getElementById('status-message').textContent = 'Track cleared.';
        });

        document.getElementById('set-tempo-btn').addEventListener('click', () => {
            const tempoInput = document.getElementById('tempo-input');
            const newBPM = parseInt(tempoInput.value);
            if (newBPM >= 40 && newBPM <= 240) {
                Tone.Transport.bpm.value = newBPM;
                document.getElementById('status-message').textContent = `BPM set to ${newBPM}.`;
            } else {
                document.getElementById('status-message').textContent = 'Please enter a valid BPM (40-240).';
            }
        });
        
        document.getElementById('download-midi-btn').addEventListener('click', () => {
             generateMidiFile();
        });


        // --- Initial Setup ---

        window.onload = () => {
            setupGrid();
            playAndDisplayChord();
            document.getElementById('status-message').textContent = 'App loaded. Click start to wake the audio engine.';
        };
    </script>
</body>
</html>
