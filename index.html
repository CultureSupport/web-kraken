<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANONYMOUS // PROJECT PHOENIX </title>
    <!-- Bulma CSS from CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- Font Awesome for Icons (Mask) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Monospace for Terminal Feel -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Base Colors and Theme */
        :root {
            --color-bg-dark: #121212;
            --color-neon-green: #00ff41;
            --color-hq-accent: #ff0077;
            --color-user-accent: #00aaff;
            --color-mid-dark: #1e1e1e;
        }

        /* Full Screen and Typography */
        html, body {
            height: 100%;
        }
        body {
            background-color: var(--color-bg-dark);
            color: var(--color-neon-green);
            font-family: 'Fira Code', monospace;
            padding: 0;
        }

        /* Full Height Container for App Fit */
        .app-container {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem 0; /* Add padding for small screens */
        }
        @media (min-width: 769px) {
            .app-container {
                padding: 0;
            }
        }

        /* Main Chat Panel Styling */
        .chat-panel {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 800px;
            height: 95vh; /* Take up 95% of viewport height */
            background-color: var(--color-mid-dark);
            border: 2px solid var(--color-neon-green);
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.4);
            overflow: hidden;
        }

        /* Header (Top Bar) */
        .chat-header {
            background-color: var(--color-bg-dark);
            color: var(--color-neon-green);
            padding: 1rem;
            border-bottom: 2px solid var(--color-neon-green);
            text-shadow: 0 0 5px rgba(0, 255, 65, 0.7);
        }

        /* Chat Log Area */
        .terminal-log {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: var(--color-mid-dark);
            /* Custom Scrollbar for Hacker Aesthetic */
            scrollbar-color: var(--color-neon-green) var(--color-mid-dark);
            scrollbar-width: thin;
        }
        .terminal-log::-webkit-scrollbar {
            width: 6px;
        }
        .terminal-log::-webkit-scrollbar-track {
            background: var(--color-mid-dark);
        }
        .terminal-log::-webkit-scrollbar-thumb {
            background-color: var(--color-neon-green);
            border-radius: 3px;
        }

        /* Chat Message Bubbles (Modern GUI) */
        .message-box {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1.25rem;
            padding: 0.75rem;
            border-radius: 8px;
            max-width: 90%;
            position: relative;
        }

        .mask-icon {
            font-size: 1.5rem;
            margin-right: 0.75rem;
        }
        
        /* HQ Leader Messages */
        .hq-leader {
            background-color: rgba(255, 0, 119, 0.1);
            border: 1px solid var(--color-hq-accent);
            color: #f0f0f0;
            margin-right: auto;
        }
        .hq-leader .mask-icon {
            color: var(--color-hq-accent);
        }

        /* User Messages (Agent) */
        .user-message {
            background-color: rgba(0, 170, 255, 0.1);
            border: 1px solid var(--color-user-accent);
            color: #f0f0f0;
            margin-left: auto;
            flex-direction: row-reverse; /* Flip content for right alignment */
            text-align: right;
        }
        .user-message .mask-icon {
            color: var(--color-user-accent);
            margin-right: 0;
            margin-left: 0.75rem;
        }
        .user-message .message-content-wrapper {
            text-align: left; /* Ensure text inside wrapper aligns left */
        }
        
        .message-header-text {
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }
        .message-content {
            font-size: 0.9rem;
            white-space: pre-wrap; /* Preserve JSON formatting */
        }

        /* Tags and Indicators */
        .tag.is-mission {
            background-color: #ffdd57;
            color: var(--color-bg-dark);
            font-weight: bold;
            margin-right: 5px;
        }
        .tag.is-protocol {
            background-color: var(--color-neon-green);
            color: var(--color-bg-dark);
            font-weight: bold;
        }

        /* Input Footer */
        .input-footer {
            padding: 1rem;
            background-color: var(--color-bg-dark);
            border-top: 2px solid var(--color-neon-green);
        }
        .input-footer .input {
            background-color: var(--color-bg-dark);
            border-color: var(--color-neon-green);
            color: var(--color-neon-green);
            box-shadow: 0 0 5px rgba(0, 255, 65, 0.5);
        }
        .input-footer .button.is-primary {
            background-color: var(--color-neon-green);
            border-color: var(--color-neon-green);
            color: var(--color-bg-dark);
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 0 8px rgba(0, 255, 65, 0.7);
        }
        .input-footer .button.is-primary:hover {
            background-color: var(--color-hq-accent);
            border-color: var(--color-hq-accent);
            box-shadow: 0 0 15px rgba(255, 0, 119, 1);
            color: white;
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="chat-panel">
        <!-- Header -->
        <div class="chat-header">
            <div class="level is-mobile">
                <div class="level-left">
                    <div class="level-item">
                        <i class="fas fa-satellite-dish mr-2" style="color: var(--color-hq-accent);"></i>
                        <h1 class="title is-4 mb-0" style="color: var(--color-neon-green);">PROJECT PHOENIX</h1>
                    </div>
                </div>
                <div class="level-right">
                    <div class="level-item has-text-right">
                        <p class="is-size-7 mr-2">
                            Status: <span id="auth-status" class="has-text-warning">Initializing...</span><br>
                            AGENT ID: <span id="user-id">A_LOADING_ID_F4K3</span>
                        </p>
                        <i class="fas fa-mask fa-2x" style="color: var(--color-user-accent);"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Log -->
        <div id="chat-log" class="terminal-log">
            <!-- Initial Message -->
            <div class="message-box hq-leader">
                <i class="fas fa-mask mask-icon"></i>
                <div class="message-content-wrapper">
                    <p class="message-header-text">HQ_SYSTEM_INIT</p>
                    <div class="message-content">Establishing secure link... Awaiting Agent ID validation...</div>
                </div>
            </div>
        </div>

        <!-- Input Footer -->
        <div class="input-footer">
            <div class="field is-grouped">
                <p class="control is-expanded">
                    <input id="chat-input" class="input is-rounded" type="text" placeholder="&gt; Enter command or response...">
                </p>
                <p class="control">
                    <button id="send-button" class="button is-primary is-rounded" onclick="sendMessage()" disabled>SEND &lt;EOC&gt;</button>
                </p>
            </div>
            <p class="has-text-danger is-size-7 mt-2" id="error-message" style="display: none;">Cannot send message: Chat is still loading or authentication failed.</p>
        </div>

    </div>
</div>

<!-- Firebase SDK Imports -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, limit, getDocs, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Set Firestore log level for debugging
    setLogLevel('Debug');

    // --- Global Variables (Provided by Canvas) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'anonymous-hacker-chat';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    // ---------------------------------------------

    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;

    // References to DOM elements
    const chatLog = document.getElementById('chat-log');
    const authStatus = document.getElementById('auth-status');
    const userIdDisplay = document.getElementById('user-id');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const errorMessage = document.getElementById('error-message');

    // Initial 20 "HQ Leader" Mission/Chat Prompts (JSON-like structure)
    const initialHqMessages = [
        { sender: "HQ_Leader", text: "Welcome, Agent. Your identifier is now validated. We have secured the initial connection protocol.", tags: ["PROTOCOL"] },
        { sender: "HQ_Leader", text: "Mission 01/20: Phase I â€” Reconnaissance. Target: Global Payment Gateway 'AetherPay'. Collect 3 non-public sub-domains. Report data in JSON format.", tags: ["MISSION", "JSON_REQUIRED"] },
        { sender: "HQ_Leader", text: "Mission 02/20: Infrastructure Mapping. Identify and document the top 5 DDoS attack vectors used against high-volume e-commerce platforms.", tags: ["MISSION"] },
        { sender: "HQ_Leader", text: "Mission 03/20: Deep Web Intel. Locate the source of the 'Mimir' zero-day exploit chatter mentioned in channel 404.", tags: ["MISSION"] },
        { sender: "HQ_Leader", text: "Mission 04/20: Audit Protocol. Review the security flaws of any popular Web 3.0 wallet service you currently use. Submit a vulnerability report (VULN-001).", tags: ["MISSION"] },
        { sender: "HQ_Leader", text: "Mission 05/20: Decentralization Study. Research current limitations of layer-2 scaling solutions for Ethereum. Summarize findings.", tags: ["MISSION"] },
        { sender: "HQ_Leader", text: "Project Phoenix Timeline Update: Q1 2026. We begin the 'Vending of Change' protocol deployment. This is critical for system status anonymity.", tags: ["UPDATE", "PROTOCOL"] },
        { sender: "HQ_Leader", text: "Mission 06/20: Social Engineering. Craft 3 convincing phishing templates targeting decentralized exchange (DEX) liquidity providers.", tags: ["MISSION"] },
        { sender: "HQ_Leader", text: "Mission 07/20: Cryptography Challenge. Decrypt the attached base64 string (simulated: 'VGhlIHN5c3RlbSBpcyBhIGxpZg==').", tags: ["MISSION"] },
        { sender: "HQ_Leader", text: "Mission 08/20: Code Review. Find the simulated buffer overflow vulnerability in the sample Rust code on Sector 7.", tags: ["MISSION"] },
        { sender: "HQ_Leader", text: "Mission 09/20: AI Defense. Develop a theoretical defense strategy against LLM prompt injection attacks for our internal chat systems.", tags: ["MISSION"] },
        { sender: "HQ_Leader", text: "Mission 10/20: Hardware Hack. Provide steps to safely flash a custom firmware on a popular consumer router model for secure routing.", tags: ["MISSION"] },
        { sender: "HQ_Leader", text: "Project Phoenix Goal: The vending will ensure system status is fully anonymous in its online operation, making it impossible to trace system actions.", tags: ["UPDATE"] },
        { sender: "HQ_Leader", text: "Mission 11/20: Data Exfiltration Plan. Outline a plan for exfiltrating a 10TB dataset across a low-bandwidth, monitored network without detection.", tags: ["MISSION"] },
        { sender: "HQ_Leader", text: "Mission 12/20: Proxy Chain Setup. Document the optimal setup for a triple-layered proxy chain using global exit nodes (must include Tor).", tags: ["MISSION"] },
        { sender: "HQ_Leader", text: "Mission 13/20: Zero-Knowledge Proofs. Explain the practical application of zk-SNARKs in achieving decentralized identity.", tags: ["MISSION"] },
        { sender: "HQ_Leader", text: "Mission 14/20: Quantum Threat. Analyze the current threat level of Shor's algorithm against our primary encryption standard (RSA-4096).", tags: ["MISSION"] },
        { sender: "HQ_Leader", text: "Mission 15/20: Supply Chain Attack. Propose a countermeasure against a simulated dependency confusion attack on our core package manager.", tags: ["MISSION"] },
        { sender: "HQ_Leader", text: "Project Phoenix Milestone: Q4 2026. Deployment of the new decentralized, card-less shopping protocol is scheduled. Zero financial footprint.", tags: ["GOAL", "PROTOCOL"] },
        { sender: "HQ_Leader", text: "We are Anonymous. We are Legion. We do not forgive. We do not forget. Expect us. Now proceed with Mission 16-20 (details pending Phase I completion).", tags: ["FINALE"] }
    ];

    /**
     * Renders a single chat message into the log.
     * @param {Object} message - The message object { sender, text, timestamp, tags? }
     */
    function renderMessage(message) {
        // Determine sender role and style
        const isHQ = message.sender === "HQ_Leader" || message.sender === "HQ_SYSTEM_INIT";
        const senderClass = isHQ ? 'hq-leader' : 'user-message';
        const senderMaskColor = isHQ ? 'var(--color-hq-accent)' : 'var(--color-user-accent)';
        const senderLabel = isHQ ? 'HQ_Leader' : `AGENT_${message.sender.substring(0, 8)}`;
        const time = message.timestamp ? new Date(message.timestamp.seconds * 1000).toLocaleTimeString() : 'INIT';

        const messageDiv = document.createElement('div');
        messageDiv.className = `message-box ${senderClass}`;

        let tagsHtml = '';
        if (message.tags && message.tags.length > 0) {
            tagsHtml = message.tags.map(tag => {
                const tagClass = tag === 'PROTOCOL' || tag === 'GOAL' ? 'is-protocol' : 'is-mission';
                return `<span class="tag is-small ${tagClass} mr-1">${tag}</span>`;
            }).join('');
        }

        const contentHTML = `
            <div class="message-content-wrapper">
                <p class="message-header-text">
                    ${tagsHtml}
                    [${time}] ${senderLabel}
                </p>
                <div class="message-content">${message.text}</div>
            </div>
        `;

        const maskHTML = `<i class="fas fa-mask mask-icon" style="color: ${senderMaskColor};"></i>`;

        // Assemble content based on sender (HQ on left, Agent on right)
        if (isHQ) {
            messageDiv.innerHTML = maskHTML + contentHTML;
        } else {
            messageDiv.innerHTML = contentHTML + maskHTML;
        }

        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight; // Scroll to bottom
    }

    /**
     * Initializes Firebase and handles authentication.
     */
    async function initializeFirebase() {
        if (!firebaseConfig) {
            authStatus.textContent = 'ERROR: No Firebase Config';
            authStatus.classList.replace('has-text-warning', 'has-text-danger');
            console.error("Firebase config is missing.");
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication using custom token or anonymously
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
                authStatus.textContent = 'AUTHORIZED & SECURED';
                authStatus.classList.replace('has-text-warning', 'has-text-success');
            } else {
                await signInAnonymously(auth);
                authStatus.textContent = 'ANONYMOUS & ENCRYPTED';
                authStatus.classList.replace('has-text-warning', 'has-text-info');
            }

            userId = auth.currentUser?.uid || crypto.randomUUID();
            userIdDisplay.textContent = userId.substring(0, 8) + '...';
            isAuthReady = true;

            // Start listening to the chat
            startChatListener();

        } catch (error) {
            console.error("Firebase Initialization or Auth Error:", error);
            authStatus.textContent = `AUTH FAILURE`;
            authStatus.classList.replace('has-text-warning', 'has-text-danger');
            errorMessage.textContent = `Connection Error: ${error.message}`;
            errorMessage.style.display = 'block';
        }
    }

    /**
     * Sets up the real-time listener for the chat log.
     */
    function startChatListener() {
        if (!db || !isAuthReady) return;

        const chatCollectionPath = `artifacts/${appId}/public/data/anonymous_chat`;
        const chatRef = collection(db, chatCollectionPath);
        
        // Check if chat is empty and inject initial missions if needed
        getDocs(query(chatRef, limit(1)))
            .then(snapshot => {
                if (snapshot.empty) {
                    injectInitialMissions(chatRef);
                }
            })
            .catch(err => console.error("Error checking for initial messages:", err));
            
        // Setup real-time listener
        const q = query(chatRef, orderBy('timestamp'));

        onSnapshot(q, (snapshot) => {
            chatLog.innerHTML = ''; // Clear existing log
            snapshot.forEach((doc) => {
                const message = doc.data();
                renderMessage(message);
            });

            // Ensure input is enabled after loading
            sendButton.disabled = false;
            chatInput.disabled = false;
            errorMessage.style.display = 'none';
        }, (error) => {
            console.error("Firestore Listener Error:", error);
            errorMessage.textContent = 'Real-time feed disconnected. Check network.';
            errorMessage.style.display = 'block';
        });
    }

    /**
     * Injects the initial 20 HQ missions into the Firestore collection.
     * @param {object} chatRef - Firestore collection reference.
     */
    function injectInitialMissions(chatRef) {
        console.log("Injecting initial 20 missions from HQ...");
        const batchPromise = runTransaction(db, async (transaction) => {
            const now = new Date();
            for (let i = 0; i < initialHqMessages.length; i++) {
                // Stagger timestamps slightly for order consistency
                const messageData = {
                    ...initialHqMessages[i],
                    timestamp: new Date(now.getTime() + i * 100)
                };
                
                // Use a document reference without ID to let Firestore auto-generate one
                const newDocRef = doc(chatRef);
                transaction.set(newDocRef, messageData);
            }
        });
        
        batchPromise.then(() => {
            console.log("Initial missions injected successfully.");
        }).catch(error => {
            console.error("Transaction failed: Failed to inject initial missions.", error);
        });
    }


    /**
     * Sends a new message to the chat. Exported to global scope for the button click.
     */
    window.sendMessage = async function() {
        if (sendButton.disabled) return;
        const text = chatInput.value.trim();
        if (!text || !db || !userId) {
            chatInput.value = '';
            return;
        }

        const newMessage = {
            sender: userId,
            text: text,
            timestamp: new Date(),
            tags: ["AGENT_RESPONSE"]
        };

        try {
            sendButton.disabled = true; // Prevent double send
            const chatCollectionPath = `artifacts/${appId}/public/data/anonymous_chat`;
            const chatRef = collection(db, chatCollectionPath);
            await addDoc(chatRef, newMessage);
            chatInput.value = ''; // Clear input on success
        } catch (error) {
            console.error("Error sending message:", error);
            errorMessage.textContent = `Failed to transmit message: ${error.message}`;
            errorMessage.style.display = 'block';
        } finally {
            sendButton.disabled = false;
        }
    }

    // Initialize the application when the page loads
    window.onload = initializeFirebase;

    // Enable sending message with Enter key
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            window.sendMessage();
        }
    });
</script>

</body>
</html>
