<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windows 98 OS </title>
    <!-- Load 98.css for the classic UI look -->
    <link rel="stylesheet" href="https://unpkg.com/98.css" />
    <!-- Load Tailwind CSS for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles to set up the desktop environment */
        body {
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent the overall browser window from scrolling */
            width: 100vw;
            height: 100vh;
        }

        /* Windows 98 Desktop Background Color and SCROLLING */
        #desktop {
            background-color: #008080; /* Teal/Turquoise */
            position: relative;
            width: 100vw;
            /* Height of desktop area: full viewport minus 24px taskbar */
            height: calc(100vh - 24px); 
            overflow-y: auto; /* Enable vertical scrolling for the desktop area */
            overflow-x: hidden; /* Keep horizontal static */
        }

        /* Taskbar positioning - SCALED DOWN (24px height) */
        #taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 24px; /* Scaled down height */
            padding: 1px 2px; /* Reduced padding */
            box-sizing: border-box;
            display: flex;
            align-items: center;
            z-index: 1000; /* Always on top */
            /* Ensure the taskbar has the classic gray background */
            background-color: #c0c0c0; 
            border-top: 2px solid #fff;
            box-shadow: none;
        }

        /* Desktop Icon styling */
        .desktop-icon {
            position: absolute;
            /* Note: Icons are positioned absolutely inside the scrollable #desktop container */
            width: 80px;
            text-align: center;
            padding: 8px 4px;
            cursor: pointer;
            color: white;
            font-size: 12px;
            line-height: 1.2;
            text-shadow: 1px 1px 0 #000;
        }

        .desktop-icon:hover {
            background: rgba(0, 0, 128, 0.5); /* Semi-transparent selection blue */
            outline: 1px dotted white;
        }
        
        /* Icon image (using placehold.co for pixel-style assets) */
        .desktop-icon img {
            width: 32px;
            height: 32px;
            margin: 0 auto 4px;
            display: block;
        }

        /* Window Styling Overrides/Helpers */
        .window {
            position: absolute;
            min-width: 300px;
            min-height: 200px;
            /* Max height adjusted for the 24px taskbar */
            max-width: 90vw;
            max-height: calc(100vh - 24px); 
            z-index: 100;
            box-shadow: 8px 8px 0 rgba(0,0,0,0.2); /* Extra shadow for depth */
            /* Added flex for IE window content layout */
            display: flex; 
            flex-direction: column;
        }

        /* Override for IE content to allow internal scrolling */
        #win-ie.window {
             /* Reset to block for initial hiding */
            display: none; 
            flex-direction: column;
        }
        
        /* Apply the actual flex structure to the window body content */
        #win-ie .window-body {
            flex-grow: 1;
            padding: 2px; /* reduced padding */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Control internal scrolling */
        }
        
        /* Address bar styling */
        .address-bar {
            padding: 2px 4px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #c0c0c0; /* Separator */
            margin-bottom: 2px;
        }

        .address-bar input {
            flex-grow: 1;
            margin-left: 4px;
            font-size: 12px;
        }

        /* Toolbar styling */
        .ie-toolbar {
            display: flex;
            padding: 1px 2px; /* Reduced top/bottom padding */
            background: #c0c0c0; /* Standard 98.css color */
            border-bottom: 1px solid #808080;
        }
        .ie-toolbar button {
            height: 24px; /* Reduced height from 28px to 24px */
            font-size: 11px;
            padding: 0 8px;
            margin-right: 2px;
            display: flex;
            align-items: center;
        }
        .ie-toolbar button span {
            margin-right: 4px;
            font-size: 18px; /* For emoji/placeholders */
        }

        .terminal-content {
            background-color: black;
            color: #ccc;
            font-family: 'Courier New', monospace;
            height: 100%;
            padding: 8px;
            overflow-y: auto;
        }

        /* DOS Text Area Styling */
        #dos-textarea {
            width: 100%; 
            height: 100%; 
            box-sizing: border-box; 
            resize: none; 
            border: none; 
            background-color: black; 
            color: #00ff00; 
            font-family: 'Courier New', monospace; 
            font-size: 14px; 
            padding: 8px; 
            outline: none;
            line-height: 1.2;
        }

        .active-taskbar-btn {
            background-color: #c0c0c0 !important;
            border-top: 1px solid black !important;
            border-left: 1px solid black !important;
            border-right: 1px solid white !important;
            border-bottom: 1px solid white !important;
            box-shadow: none !important;
        }
        
        /* Ensure taskbar buttons and clock fit the smaller height */
        #taskbar button.taskbar-button {
            height: 22px; /* slightly less than taskbar height */
            font-size: 11px;
            line-height: 1;
        }
        
        /* Force Start button height/alignment to match taskbar buttons */
        #taskbar #start-btn {
            height: 22px;
            padding: 0 4px; /* Adjust padding to keep content snug */
            line-height: 20px; /* Help vertical alignment */
        }

        #taskbar #sys-clock {
            height: 22px;
            line-height: 20px; /* Center text vertically */
        }

        /* Full height iframe inside IE window */
        #ie-content {
            flex-grow: 1;
            width: 100%;
            border: 1px inset #c0c0c0;
            background-color: white;
        }

        /* Styling for the My Computer file view */
        .file-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 20px;
            padding: 16px;
            flex-grow: 1;
            overflow-y: auto;
        }
        .file-item {
            text-align: center;
            cursor: pointer;
            padding: 8px;
        }
        .file-item img {
            width: 48px;
            height: 48px;
            margin-bottom: 4px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .file-item:hover {
            background: #000080;
            color: white;
            outline: 1px dotted white;
        }

    </style>
</head>
<body>

    <div id="desktop">
        <!-- Desktop Icons -->
        
        <!-- NEW ICON: My Computer -->
        <div class="desktop-icon" id="icon-my-computer" style="top: 20px; left: 20px;">
            <!-- Computer Icon -->
            <img src="https://placehold.co/32x32/000080/FFFFFF?text=PC" alt="My Computer Icon">
            My Computer
        </div>
        
        <div class="desktop-icon" id="icon-ie" style="top: 110px; left: 20px;">
            <!-- Globe for Internet Explorer -->
            <img src="https://placehold.co/32x32/0000AA/FFFF00?text=Net" alt="IE Icon">
            Internet Explorer
        </div>

        <div class="desktop-icon" id="icon-terminal" style="top: 200px; left: 20px;">
            <!-- Black screen with C> for MS-DOS Prompt -->
            <img src="https://placehold.co/32x32/000000/00FF00?text=DOS" alt="Terminal Icon">
            MS-DOS Prompt
        </div>
        
        <!-- NEW ICON: DOS Text Program -->
        <div class="desktop-icon" id="icon-dos-text" style="top: 290px; left: 20px;">
            <!-- Text Icon (simulating EDIT.COM) -->
            <img src="https://placehold.co/32x32/C0C0C0/000000?text=TXT" alt="DOS Text Icon">
            DOS Text Program
        </div>

        <div class="desktop-icon" id="icon-c-terminal" style="top: 380px; left: 20px;">
            <!-- Compiler/Code Icon -->
            <img src="https://placehold.co/32x32/800000/FFFFFF?text=Code" alt="C Terminal Icon">
            C Terminal Window
        </div>

        <div class="desktop-icon" id="icon-remote-desktop" style="top: 470px; left: 20px;">
            <!-- Monitor/PC Icon for Remote Desktop -->
            <img src="https://placehold.co/32x32/000000/FFFFFF?text=PC" alt="Remote Desktop Icon">
            Remote Desktop
        </div>

        <div class="desktop-icon" id="icon-dev-links" style="top: 560px; left: 20px;">
            <!-- Folder Icon for Links -->
            <img src="https://placehold.co/32x32/800080/FFFF00?text=Link" alt="Dev Links Icon">
            Software Links
        </div>
        
        <!-- ICON TO FORCE SCROLLBAR -->
        <div class="desktop-icon" id="icon-about" style="top: 1000px; left: 20px;">
            <img src="https://placehold.co/32x32/00FFFF/000000?text=i" alt="About Icon">
            About Simulation
        </div>


        <!-- Window Containers (Initially Hidden) -->
        
        <!-- My Computer Window -->
        <div id="win-my-computer" class="window" style="display:none; top: 80px; left: 180px; width: 450px; height: 350px;">
            <div class="title-bar">
                <div class="title-bar-text">My Computer</div>
                <div class="title-bar-controls">
                    <button aria-label="Minimize"></button>
                    <button aria-label="Maximize"></button>
                    <button aria-label="Close"></button>
                </div>
            </div>
             <menu role="menubar" class="border-b">
                <li role="menuitem">File</li>
                <li role="menuitem">Edit</li>
                <li role="menuitem">View</li>
                <li role="menuitem">Go</li>
                <li role="menuitem">Favorites</li>
                <li role="menuitem">Help</li>
            </menu>
            <div class="window-body">
                <div class="file-view">
                    <!-- Storage Devices -->
                    <div class="file-item">
                        <img src="https://placehold.co/48x48/000080/FFFFFF?text=3.5" alt="Floppy Disk">
                        3½ Floppy (A:)
                    </div>
                    <div class="file-item">
                        <img src="https://placehold.co/48x48/00AA00/FFFFFF?text=HDD" alt="Hard Drive">
                        Local Disk (C:)
                    </div>
                    <div class="file-item">
                        <img src="https://placehold.co/48x48/FF0000/FFFFFF?text=CD" alt="CD-ROM">
                        CD-ROM Drive (D:)
                    </div>
                    <!-- System Folders -->
                     <div class="file-item">
                        <img src="https://placehold.co/48x48/C0C0C0/000000?text=P" alt="Printers">
                        Printers
                    </div>
                     <div class="file-item">
                        <img src="https://placehold.co/48x48/C0C0C0/000000?text=Ctrl" alt="Control Panel">
                        Control Panel
                    </div>
                </div>
                <footer class="status-bar">
                    <p class="status-bar-field">6 objects</p>
                </footer>
            </div>
        </div>

        <!-- DOS Text Editor Window - UPDATED FOR FIREBASE PERSISTENCE -->
        <div id="win-dos-text" class="window" style="display:none; top: 120px; left: 280px; width: 500px; height: 350px;">
            <div class="title-bar">
                <div class="title-bar-text">EDIT - README.TXT</div>
                <div class="title-bar-controls">
                    <button aria-label="Minimize"></button>
                    <button aria-label="Maximize"></button>
                    <button aria-label="Close"></button>
                </div>
            </div>
            <!-- Simulated Menu Bar with interaction elements -->
            <div class="terminal-menu" style="background-color: #000080; color: #ccc; font-family: 'Courier New', monospace; padding: 4px; display: flex; align-items: center;">
                <!-- Clickable area to simulate menu drop-down and trigger Save -->
                <button id="dos-save" class="text-xs" style="background-color: #c0c0c0; color: black; padding: 0 4px; height: 20px;">File (Save)</button>
                <button id="dos-save-as" class="text-xs" style="background-color: #c0c0c0; color: black; padding: 0 4px; margin-left: 10px; height: 20px;">Save As...</button>
                <span id="dos-status-message" class="text-xs ml-4 text-yellow-300">Ready.</span>
            </div>
            <div class="window-body p-0" style="height: calc(100% - 60px);"> <!-- Adjust height for menu and title bar -->
                <textarea id="dos-textarea" autofocus>Loading...</textarea>
            </div>
            <footer class="status-bar">
                <p class="status-bar-field" id="dos-line-col">Line: 1 Col: 1</p>
            </footer>
        </div>

        <!-- Internet Explorer Window -->
        <div id="win-ie" class="window" style="top: 50px; left: 150px; width: 600px; height: 400px;">
            <div class="title-bar">
                <div class="title-bar-text">Internet Explorer - Welcome to Windows 98</div>
                <div class="title-bar-controls">
                    <button aria-label="Minimize"></button>
                    <button aria-label="Maximize"></button>
                    <button aria-label="Close"></button>
                </div>
            </div>
            
            <!-- Standard Menu Bar -->
            <menu role="menubar" class="border-b">
                <li role="menuitem">File</li>
                <li role="menuitem">Edit</li>
                <li role="menuitem">View</li>
                <li role="menuitem">Go</li>
                <li role="menuitem">Favorites</li>
                <li role="menuitem">Help</li>
            </menu>

            <!-- Navigation Toolbar -->
            <div class="ie-toolbar">
                <button id="ie-back"><span>&lt;</span> Back</button>
                <button id="ie-forward"><span>&gt;</span> Forward</button>
                <button id="ie-stop"><span>◼</span> Stop</button>
                <button id="ie-refresh"><span>↻</span> Refresh</button>
                <button id="ie-home"><span>⌂</span> Home</button>
            </div>

            <!-- Address Bar -->
            <div class="address-bar">
                <label for="ie-address">Address:</label>
                <div class="sunken-panel" style="flex-grow: 1;">
                    <input type="text" id="ie-address" value="https://www.google.com/search?q=windows+98+aesthetic" />
                </div>
                <button id="ie-go" style="margin-left: 4px;">Go</button>
            </div>

            <div class="window-body">
                <iframe id="ie-content" src="https://www.google.com/search?q=windows+98+aesthetic" frameborder="0"></iframe>
            </div>
            
        </div>

        <!-- Local Terminal Window -->
        <div id="win-terminal" class="window" style="display:none; top: 100px; left: 200px; width: 450px; height: 300px;">
            <div class="title-bar">
                <div class="title-bar-text">MS-DOS Prompt</div>
                <div class="title-bar-controls">
                    <button aria-label="Minimize"></button>
                    <button aria-label="Maximize"></button>
                    <button aria-label="Close"></button>
                </div>
            </div>
            <div class="window-body p-0" style="height: calc(100% - 30px);">
                <div class="terminal-content">
                    <p>Microsoft(R) Windows 98<br> &nbsp; &nbsp; &nbsp; (C)Copyright Microsoft Corp 1981-1999.</p>
                    <p>C:\&gt; _</p>
                    <p>C:\&gt; help<br>
                        Type the name of a program you want to open:<br>
                        - ie (Internet Explorer)<br>
                        - links (Software Links)<br>
                        - rdp (Remote Desktop Mock)</p>
                    <p>C:\&gt; _</p>
                </div>
            </div>
        </div>

        <!-- C Terminal Window -->
        <div id="win-c-terminal" class="window" style="display:none; top: 150px; left: 250px; width: 450px; height: 300px;">
            <div class="title-bar">
                <div class="title-bar-text">C:\TurboC\BIN\HELLO.EXE</div>
                <div class="title-bar-controls">
                    <button aria-label="Minimize"></button>
                    <button aria-label="Maximize"></button>
                    <button aria-label="Close"></button>
                </div>
            </div>
            <div class="window-body p-0" style="height: calc(100% - 30px);">
                <div class="terminal-content">
                    <p>C Terminal Program Initialized.<br></p>
                    <p>// C:\TURBOC\BIN\HELLO.C</p>
                    <p>#include &lt;stdio.h&gt;<br>
                       int main() {<br>
                       &nbsp; &nbsp; printf("Hello, Windows 98 World!\n");<br>
                       &nbsp; &nbsp; return 0;<br>
                       }</p>
                    <p>Output:<br>
                       Hello, Windows 98 World!</p>
                    <p>Press any key to exit...</p>
                </div>
            </div>
        </div>
        
        <!-- Remote Desktop Mock Window -->
        <div id="win-remote-desktop" class="window" style="display:none; top: 180px; left: 300px; width: 350px; height: 200px;">
            <div class="title-bar">
                <div class="title-bar-text">Remote Desktop Connection</div>
                <div class="title-bar-controls">
                    <button aria-label="Minimize"></button>
                    <button aria-label="Maximize"></button>
                    <button aria-label="Close"></button>
                </div>
            </div>
            <div class="window-body p-4 text-center">
                <p class="font-bold mb-2">Connecting to HOSTNAME_PC...</p>
                <div class="field-row" style="justify-content: center;">
                    <div class="progress" style="width: 80%;">
                        <div class="progress-bar" style="width: 60%;"></div>
                    </div>
                </div>
                <p class="mt-4 text-sm">To establish an active RDP session, you would typically use dedicated client software like Microsoft Terminal Services Client (MSTSC).</p>
            </div>
        </div>

        <!-- Software Links Window -->
        <div id="win-dev-links" class="window" style="display:none; top: 200px; left: 350px; width: 400px; height: 250px;">
            <div class="title-bar">
                <div class="title-bar-text">Software Links & Resources</div>
                <div class="title-bar-controls">
                    <button aria-label="Minimize"></button>
                    <button aria-label="Maximize"></button>
                    <button aria-label="Close"></button>
                </div>
            </div>
            <div class="window-body p-4">
                <p class="font-bold mb-2">Development Resources:</p>
                <ul class="tree-view">
                    <li><a href="https://github.com/google" target="_blank">Google Github Organization</a></li>
                    <li><a href="https://gemini.google.com/" target="_blank">Gemini Web Interface</a></li>
                    <li><a href="https://www.google.com/" target="_blank">General Web Browser</a></li>
                </ul>
                <div class="sunken-panel mt-4 p-2 text-xs">
                    <p>These are external links that will open in a new browser tab, just like in a real OS!</p>
                </div>
            </div>
        </div>

        <!-- About Window -->
        <div id="win-about" class="window" style="display:none; top: 150px; left: 500px; width: 300px; height: 150px;">
            <div class="title-bar">
                <div class="title-bar-text">About Windows 98 Simulation</div>
                <div class="title-bar-controls">
                    <button aria-label="Minimize"></button>
                    <button aria-label="Maximize"></button>
                    <button aria-label="Close"></button>
                </div>
            </div>
            <div class="window-body p-4 text-center">
                <p class="mb-2">This is a simulated Windows 98 desktop environment using 98.css.</p>
                <p class="font-bold">Created by Gemini.</p>
            </div>
        </div>


    </div>

    <!-- Taskbar -->
    <footer id="taskbar">
        <!-- Start Button -->
        <button id="start-btn" class="start-menu-button">
            <!-- Start button logo adjusted for smaller taskbar height. Added vertical-align: middle. -->
            <img src="https://placehold.co/16x16/000080/C0C0C0?text=W" alt="W98 Logo" style="margin-right: 4px; border: 1px outset #fff; height: 16px; vertical-align: middle;">
            Start
        </button>

        <!-- Taskbar Buttons (Containers for minimized windows) -->
        <div id="taskbar-apps" style="display: flex; flex-grow: 1; margin-left: 4px;">
            <!-- Taskbar buttons will be dynamically added here -->
        </div>

        <!-- Clock Placeholder -->
        <div class="field-row" style="margin-left: auto;">
            <div class="sunken-panel" style="width: 60px; text-align: center; font-size: 11px;" id="sys-clock">
                <!-- Time will be inserted here by JS -->
            </div>
        </div>
    </footer>


    <script type="module">
        // Firebase Global Variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const desktop = document.getElementById('desktop');
        const taskbarApps = document.getElementById('taskbar-apps');
        const windows = {};
        const iconMap = {
            'icon-my-computer': { id: 'win-my-computer', title: 'My Computer' },
            'icon-ie': { id: 'win-ie', title: 'Internet Explorer' },
            'icon-terminal': { id: 'win-terminal', title: 'MS-DOS Prompt' },
            'icon-dos-text': { id: 'win-dos-text', title: 'DOS Text Program' },
            'icon-c-terminal': { id: 'win-c-terminal', title: 'C Terminal Window' },
            'icon-remote-desktop': { id: 'win-remote-desktop', title: 'Remote Desktop' },
            'icon-dev-links': { id: 'win-dev-links', title: 'Software Links' },
            'icon-about': { id: 'win-about', title: 'About Simulation' },
        };
        let zIndexCounter = 100;
        const HOME_URL = "https://www.google.com/search?q=windows+98+aesthetic";
        
        let app, db, auth, userId = null;
        const TEXT_DOC_ID = 'dos_text_file'; // Fixed document ID for the text file

        /**
         * Firebase Initialization and Persistence Functions
         */

        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is missing.");
                    return;
                }

                setLogLevel('Debug');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in using the provided custom token or anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase initialized. User ID:", userId);
                    } else {
                        console.log("User signed out or anonymous.");
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
            }
        }

        function getFileDocRef() {
            if (!db || !userId) {
                console.error("Database or user not initialized.");
                return null;
            }
            // Private data path: /artifacts/{appId}/users/{userId}/text_files/{documentId}
            const path = `artifacts/${appId}/users/${userId}/text_files/${TEXT_DOC_ID}`;
            return doc(db, path);
        }

        async function saveTextFile() {
            if (!userId) {
                updateDosStatus("ERROR: Sign-in required to save.", 3000);
                return;
            }
            
            const textarea = document.getElementById('dos-textarea');
            const docRef = getFileDocRef();
            if (!docRef) return;

            try {
                updateDosStatus("Saving file...");
                await setDoc(docRef, { content: textarea.value, savedAt: new Date().toISOString() });
                updateDosStatus("File saved successfully!", 3000);
            } catch (error) {
                console.error("Error saving document:", error);
                updateDosStatus("ERROR: Failed to save file.", 3000);
            }
        }

        async function loadTextFile() {
            if (!userId) {
                // Wait for auth to complete
                return new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            unsubscribe();
                            userId = user.uid;
                            resolve(await loadTextFileInternal());
                        }
                    });
                });
            }
            return loadTextFileInternal();
        }

        async function loadTextFileInternal() {
            const textarea = document.getElementById('dos-textarea');
            const docRef = getFileDocRef();
            if (!docRef) {
                textarea.value = "ERROR: Could not load file. Database not ready.";
                return;
            }

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    textarea.value = docSnap.data().content;
                    updateDosStatus("File loaded from cloud.");
                } else {
                    textarea.value = `C:\> EDIT README.TXT\n\nWelcome to the DOS Text Editor.\n----------------------------------\nTo save this file permanently, click the 'File (Save)' button.\nTo download a local copy, click the 'Save As...' button.\n\nC:\>_`;
                    updateDosStatus("New file created.");
                }
            } catch (error) {
                console.error("Error loading document:", error);
                textarea.value = "ERROR: Failed to load file from cloud.";
                updateDosStatus("ERROR: Failed to load file.", 5000);
            }
        }
        
        function saveAsLocalFile() {
            const textarea = document.getElementById('dos-textarea');
            const content = textarea.value;
            const filename = "README.txt";
            
            // Create a Blob from the content
            const blob = new Blob([content], { type: 'text/plain' });
            
            // Create a link element
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            
            // Append link to body, click it, and remove it
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            updateDosStatus(`File downloaded as ${filename}`, 3000);
        }

        function updateDosStatus(message, timeout = 0) {
            const statusElement = document.getElementById('dos-status-message');
            if (statusElement) {
                statusElement.textContent = message;
                if (timeout > 0) {
                    setTimeout(() => {
                        statusElement.textContent = "Ready.";
                    }, timeout);
                }
            }
        }

        /**
         * Window Management Functions
         */

        function bringToFront(windowId) {
            const win = windows[windowId].element;
            // Only update z-index if it's not already the highest
            if (parseInt(win.style.zIndex) < zIndexCounter) {
                zIndexCounter++;
                win.style.zIndex = zIndexCounter;
            }
            // Update taskbar focus state
            document.querySelectorAll('#taskbar-apps button').forEach(btn => {
                btn.classList.remove('active-taskbar-btn');
            });
            const taskbarBtn = windows[windowId].taskbarButton;
            if (taskbarBtn && win.style.display !== 'none') {
                 // Check if the window is currently visible
                taskbarBtn.classList.add('active-taskbar-btn');
            }
        }

        function openWindow(windowId, title) {
            const win = windows[windowId].element;
            const isFlex = windowId === 'win-ie' || windowId === 'win-my-computer';
            const displayType = isFlex ? 'flex' : 'block';
            
            if (win.style.display === 'none') {
                win.style.display = displayType;
                
                // Special handling for DOS Text Editor on open
                if (windowId === 'win-dos-text') {
                    loadTextFile();
                }

                // Restore previous state or default size
                if (windows[windowId].isMaximized) {
                    maximizeWindow(windowId);
                } else {
                    win.style.width = windows[windowId].width;
                    win.style.height = windows[windowId].height;
                    win.style.top = windows[windowId].top;
                    win.style.left = windows[windowId].left;
                }
            }
            bringToFront(windowId);
        }

        function minimizeWindow(windowId) {
            const win = windows[windowId].element;
            win.style.display = 'none';
            // De-focus taskbar button
            windows[windowId].taskbarButton.classList.remove('active-taskbar-btn');
        }

        function closeWindow(windowId) {
            const win = windows[windowId].element;
            win.style.display = 'none';
            // Remove taskbar button
            windows[windowId].taskbarButton.remove();
            delete windows[windowId];
        }
        
        function maximizeWindow(windowId) {
            const win = windows[windowId].element;
            const taskbarHeight = 24; // Updated to match the scaled down CSS height
            
            // Check if already maximized
            if (windows[windowId].isMaximized) {
                 // Restore
                win.style.width = windows[windowId].width;
                win.style.height = windows[windowId].height;
                win.style.top = windows[windowId].top;
                win.style.left = windows[windowId].left;
                windows[windowId].isMaximized = false;
            } else {
                // Save current position/size before maximizing
                windows[windowId].width = win.style.width;
                windows[windowId].height = win.style.height;
                windows[windowId].top = win.style.top;
                windows[windowId].left = win.style.left;

                // Maximize
                win.style.width = '100vw';
                win.style.height = `calc(100vh - ${taskbarHeight}px)`;
                win.style.top = '0';
                win.style.left = '0';
                windows[windowId].isMaximized = true;
            }
            bringToFront(windowId);
        }

        /**
         * IE Toolbar Functions
         */
        function handleIEToolbar(windowId) {
            const win = windows[windowId].element;
            const iframe = win.querySelector('#ie-content');
            const addressInput = win.querySelector('#ie-address');

            const navigate = (url) => {
                if (url && url.startsWith('http')) {
                    iframe.src = url;
                    addressInput.value = url;
                } else if (url) {
                    // Simple search if protocol is missing
                    iframe.src = `https://www.google.com/search?q=${encodeURIComponent(url)}`;
                    addressInput.value = url;
                }
            };

            win.querySelector('#ie-back').onclick = () => {
                try { iframe.contentWindow.history.back(); } catch (e) { console.error('Back navigation blocked:', e); }
            };
            win.querySelector('#ie-forward').onclick = () => {
                try { iframe.contentWindow.history.forward(); } catch (e) { console.error('Forward navigation blocked:', e); }
            };
            win.querySelector('#ie-stop').onclick = () => {
                try { iframe.contentWindow.stop(); } catch (e) { console.error('Stop command failed:', e); }
            };
            win.querySelector('#ie-refresh').onclick = () => {
                try { iframe.contentWindow.location.reload(); } catch (e) { console.error('Reload command failed:', e); }
            };
            win.querySelector('#ie-home').onclick = () => {
                navigate(HOME_URL);
            };

            // Go button and Enter key in address bar
            const goAction = () => {
                let url = addressInput.value.trim();
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    // Default to search if no protocol is specified
                    url = `https://www.google.com/search?q=${encodeURIComponent(url)}`;
                }
                navigate(url);
            };

            win.querySelector('#ie-go').onclick = goAction;
            addressInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    goAction();
                }
            });

            // Update address bar when iframe successfully navigates (if cross-origin policy allows)
            iframe.onload = () => {
                try {
                    addressInput.value = iframe.contentWindow.location.href;
                } catch(e) {
                    // This error is expected for cross-origin URLs (like Google search)
                    console.warn("Could not read iframe location due to cross-origin policy.");
                }
            };
        }

        /**
         * Initialization and Event Setup
         */

        function setupWindow(winElement, windowId) {
            const titleBar = winElement.querySelector('.title-bar');
            const [minBtn, maxBtn, closeBtn] = titleBar.querySelectorAll('.title-bar-controls button');
            const title = winElement.querySelector('.title-bar-text').textContent;

            // 1. Taskbar Setup
            const taskbarBtn = document.createElement('button');
            taskbarBtn.textContent = title;
            taskbarBtn.classList.add('taskbar-button');
            taskbarBtn.addEventListener('click', () => {
                if (winElement.style.display === 'none') {
                    openWindow(windowId);
                } else {
                    // Toggle visibility/focus
                    if (winElement.style.zIndex === zIndexCounter.toString()) {
                        minimizeWindow(windowId);
                    } else {
                        bringToFront(windowId);
                    }
                }
            });
            taskbarApps.appendChild(taskbarBtn);

            // Store window state
            windows[windowId] = {
                element: winElement,
                taskbarButton: taskbarBtn,
                isMaximized: false,
                width: winElement.style.width,
                height: winElement.style.height,
                top: winElement.style.top,
                left: winElement.style.left,
            };

            // 2. Control Button Setup
            minBtn.onclick = () => minimizeWindow(windowId);
            maxBtn.onclick = () => maximizeWindow(windowId);
            closeBtn.onclick = () => closeWindow(windowId);

            // 3. Focus/Z-Index
            winElement.addEventListener('mousedown', () => bringToFront(windowId));
            
            // 4. IE Toolbar setup (if applicable)
            if (windowId === 'win-ie') {
                handleIEToolbar(windowId);
            }
            
            // 5. DOS Text Editor controls
            if (windowId === 'win-dos-text') {
                document.getElementById('dos-save').addEventListener('click', saveTextFile);
                document.getElementById('dos-save-as').addEventListener('click', saveAsLocalFile);
                
                const textarea = document.getElementById('dos-textarea');
                const lineColStatus = document.getElementById('dos-line-col');

                // Update line/column status
                const updateLineCol = () => {
                    const cursorPos = textarea.selectionStart;
                    const text = textarea.value.substring(0, cursorPos);
                    const lines = text.split('\n');
                    const line = lines.length;
                    const col = lines[lines.length - 1].length + 1;
                    lineColStatus.textContent = `Line: ${line} Col: ${col}`;
                };
                
                textarea.addEventListener('input', updateLineCol);
                textarea.addEventListener('click', updateLineCol);
                textarea.addEventListener('keyup', updateLineCol);
                textarea.addEventListener('focus', updateLineCol);
            }

            // 6. Dragging Logic
            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            const dragStart = (e) => {
                if (windows[windowId].isMaximized) return;

                if (e.target === titleBar || titleBar.contains(e.target)) {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                    isDragging = true;
                    bringToFront(windowId);
                }
            };

            const drag = (e) => {
                if (isDragging) {
                    e.preventDefault();
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    winElement.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
                }
            };

            const dragEnd = () => {
                if (isDragging) {
                    const rect = winElement.getBoundingClientRect();

                    winElement.style.left = `${rect.left}px`;
                    winElement.style.top = `${rect.top}px`;

                    winElement.style.transform = 'none';
                    xOffset = 0;
                    yOffset = 0;
                    
                    windows[windowId].top = winElement.style.top;
                    windows[windowId].left = winElement.style.left;
                }
                isDragging = false;
            };

            titleBar.addEventListener('mousedown', dragStart);
            desktop.addEventListener('mousemove', drag);
            desktop.addEventListener('mouseup', dragEnd);
            
            // Double-click on title bar for Maximize
            titleBar.addEventListener('dblclick', (e) => {
                if (e.target === titleBar || titleBar.contains(e.target)) {
                    maximizeWindow(windowId);
                }
            });
        }


        // Clock Update Function
        function updateClock() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            document.getElementById('sys-clock').textContent = `${hours}:${minutes}`;
        }

        // Main Initialization
        window.onload = async function() {
            await initializeFirebase(); // Initialize Firebase first

            // Setup all windows
            Object.values(iconMap).forEach(item => {
                const winElement = document.getElementById(item.id);
                if (winElement) {
                    setupWindow(winElement, item.id);
                    // Ensure windows are initially hidden
                    winElement.style.display = 'none';
                }
            });

            // Setup icon click handlers
            Object.keys(iconMap).forEach(iconId => {
                const iconElement = document.getElementById(iconId);
                if (iconElement) {
                    iconElement.addEventListener('click', () => openWindow(iconMap[iconId].id));
                    iconElement.addEventListener('dblclick', () => openWindow(iconMap[iconId].id));
                }
            });

            // Start clock
            updateClock();
            setInterval(updateClock, 60000); // Update every minute
            
        };

    </script>
</body>
</html>
